
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Example 2: Cell with lamellipodia &#8212; u-Unwrap3D Analysis Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_basic_workflow/full_example_cells/unwrap_lamellipodia_cell';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Example 3: Cell with filopodia" href="unwrap_filopodia_cell.html" />
    <link rel="prev" title="Example 1: Cell with blebs" href="unwrap_bleb_cell.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">u-Unwrap3D Analysis Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    u-Unwrap3D Analysis Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../01_introduction/readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_installation/readme.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Standard Workflow</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Standard workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step0_find_cell_surface_from_segmentation.html">Step 0: Segmenting a single cell from a volume image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step1_find_reference_surface.html">Step 1: Find and create a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step2_quasiconformal_spherical_parameterization.html">Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step3_equiareal_spherical_parameterization.html">Step 3: Quasi-equiareal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step4_uv_mapping_spherical_parameterization.html">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> into 2D using its spherical parameterization, <span class="math notranslate nohighlight">\(S_{\text{ref}}^{\Omega}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step5_building_topography_surface.html">Step 5: Building the topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step6_find_topographic_surface_mesh.html">Step 6: Compute topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> from topographic binary segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Step7_topographic_cMCF_to_flatten.html">Step 7: Flattening the topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> onto the 2D plane</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="readme.html">Full examples of standard workflow</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="unwrap_bleb_cell.html">Example 1: Cell with blebs</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Example 2: Cell with lamellipodia</a></li>
<li class="toctree-l2"><a class="reference internal" href="unwrap_filopodia_cell.html">Example 3: Cell with filopodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Customizing the standard workflow to input data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../04_customizing_basic_workflow/readme.html">Customizing the standard workflow for downstream analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">In-depth Breakdown of Mapping Steps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../05_obtaining_surfaces/readme.html">Extracting surfaces from microscopy imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_find_reference_surface/readme.html">Finding the best reference shape for the analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_uv_parameterization/readme.html">UV unwrapping of spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_building_topography_space/readme.html">Building topography space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_spherical_parameterization/readme.html">Spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_flatten_topography_surface/readme.html">Flattening topography surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transporting measurements between representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../22_transporting_measurements/readme.html">Transferring measurements across meshes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applying u-Unwrap3D to live-cell imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../16_shape_registration/readme.html">Shape registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../15_compute_distortion_corrected_uv_measurements/readme.html">Computing distortion-corrected measurements for analysis in uv and topopraphy space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../20_surface_flow_analytics/readme.html">Motion and information flow of measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../19_tracking_in_uv/readme.html">Tracking protrusions in 2D uv space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../21_tracking_analytics/readme.html">Analyzing temporally tracked protrusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applications of different surface representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../13_segmenting_surface_protrusions/readme.html">Segmenting surface protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../13_segmenting_surface_protrusions/binary_segment_protrusions.html">Binary protrusion segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../13_segmenting_surface_protrusions/instance_segment_protrusions.html">Instance protrusion segmentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_volumizing_reference_and_protrusions/readme.html">Decomposing surface into reference and protrusion meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../18_spherical_harmonics/readme.html">Harmonics analysis of surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mapping open 3D surfaces into 2D</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../12_unwrapping_individual_protrusions/readme.html">Unwrapping individual protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../12_unwrapping_individual_protrusions/unwrap_lamellipodia_protrusion.html">Example: Unwrapping a lamellipodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../01_introduction/glossary.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks/issues/new?title=Issue%20on%20page%20%2F03_basic_workflow/full_example_cells/unwrap_lamellipodia_cell.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/03_basic_workflow/full_example_cells/unwrap_lamellipodia_cell.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example 2: Cell with lamellipodia</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-the-surface-mesh">0. Read in the surface mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-cmcf-to-get-reference-shape">1. run cMCF to get reference shape</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conformal-spherical-parameterization">2. Conformal Spherical parameterization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#equiareal-spherical-parameterization">3. Equiareal Spherical parameterization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uv-map">4. UV map</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-topography-space">5. Build Topography space</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-topographic-surface">6. Extract topographic surface</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="example-2-cell-with-lamellipodia">
<h1>Example 2: Cell with lamellipodia<a class="headerlink" href="#example-2-cell-with-lamellipodia" title="Link to this heading">#</a></h1>
<p>The cell surface is located in <code class="docutils literal notranslate"><span class="pre">../../../data/mesh/lamellipodia_cell.obj</span></code>. It was derived by applying marching cubes with pyacvd remeshing in u-Unwrap3D after segmentation using <a class="reference external" href="https://github.com/DanuserLab/u-segment3D">u-Segment3D</a> using this <a class="reference external" href="https://github.com/DanuserLab/u-segment3D/blob/master/tutorials/single_cells/segment_lamellipodia_3D.py">script</a>.</p>
<section id="read-in-the-surface-mesh">
<h2>0. Read in the surface mesh<a class="headerlink" href="#read-in-the-surface-mesh" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Mesh.meshtools</span> <span class="k">as</span> <span class="nn">meshtools</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Utility_Functions.file_io</span> <span class="k">as</span> <span class="nn">fio</span> <span class="c1"># for common IO functions</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Unzipping.unzip</span> <span class="k">as</span> <span class="nn">uzip</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Segmentation.segmentation</span> <span class="k">as</span> <span class="nn">segmentation</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Image_Functions.image</span> <span class="k">as</span> <span class="nn">image_fn</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Analysis_Functions.topography</span> <span class="k">as</span> <span class="nn">topo_tools</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.colors</span> <span class="k">as</span> <span class="nn">vol_colors</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> 
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span> 
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Specifying image file location and parsing its name. </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">meshfolder</span> <span class="o">=</span> <span class="s1">&#39;../../../data/mesh&#39;</span>
<span class="n">meshfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meshfolder</span><span class="p">,</span> <span class="s1">&#39;lamellipodia_cell.obj&#39;</span><span class="p">)</span>

<span class="n">basefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">meshfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.obj&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the filename with extension</span>

<span class="n">mesh_S</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">meshfile</span><span class="p">,</span>
                             <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># read only the largest if there is multiple separate objects in the mesh</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Create a master save folder</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">savefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;example_results&#39;</span><span class="p">,</span> 
                         <span class="n">basefname</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder</span><span class="p">)</span> <span class="c1"># auto generates the specified folder structure if doesn&#39;t currently exist.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Create subfolder within master save folder of the cell to store specifics of the input </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">savefolder_surf_S</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                 <span class="s1">&#39;Step0_input_surface_S&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_surf_S</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">We don&#39;t have the binary, therefore we voxelize the mesh to create one</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">mesh_S_binary</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">voxelize_image_mesh_pts</span><span class="p">(</span><span class="n">mesh_S</span><span class="p">,</span> 
                                                  <span class="n">pad</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> 
                                                  <span class="n">dilate_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                                  <span class="n">erode_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                                  <span class="n">vol_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">mesh_S_binary</span> <span class="o">=</span> <span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># transpose so the binary is in the same format as the standard workflow</span>

<span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_surf_S</span><span class="p">,</span>
                         <span class="s1">&#39;mesh_S_binary.tif&#39;</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mf">255.</span><span class="o">*</span><span class="n">mesh_S_binary</span><span class="p">))</span>


<span class="c1"># measure the surface curvature from the binary</span>
<span class="n">voxel_size</span> <span class="o">=</span> <span class="mf">0.160</span> <span class="c1">#um</span>

<span class="n">surf_H</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">compute_mean_curvature_from_binary</span><span class="p">(</span><span class="n">mesh_S</span><span class="p">,</span> 
                                                    <span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
                                                    <span class="n">smooth_gradient</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                                    <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                                                    <span class="n">invert_H</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">return_H_img</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># we just want the curvature</span>
<span class="n">surf_H_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">surf_H</span><span class="o">/</span><span class="n">voxel_size</span><span class="p">,</span> 
                                      <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">,</span> 
                                      <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mesh_S</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mf">255.</span><span class="o">*</span><span class="n">surf_H_colors</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_S</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_surf_S</span><span class="p">,</span> 
                                 <span class="s1">&#39;input_mesh_S.obj&#39;</span><span class="p">))</span>

<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_surf_S</span><span class="p">,</span> 
                          <span class="s1">&#39;curvature_stats.mat&#39;</span><span class="p">),</span>
                          <span class="p">{</span><span class="s1">&#39;voxel_size&#39;</span><span class="p">:</span><span class="n">voxel_size</span><span class="p">,</span>
                           <span class="s1">&#39;surf_H&#39;</span><span class="p">:</span> <span class="n">surf_H</span><span class="p">,</span> 
                           <span class="s1">&#39;surf_H_colors&#39;</span><span class="p">:</span> <span class="n">surf_H_colors</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-cmcf-to-get-reference-shape">
<h2>1. run cMCF to get reference shape<a class="headerlink" href="#run-cmcf-to-get-reference-shape" title="Link to this heading">#</a></h2>
<p>We use a slower flow than the standard workflow example to catch better the transition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_cMCF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                 <span class="s1">&#39;Step1_cMCF_reference&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">)</span>

<span class="n">Usteps_MCF_img</span><span class="p">,</span> <span class="n">mesh_F</span><span class="p">,</span> <span class="n">MCF_measures_dict</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">conformalized_mean_curvature_flow</span><span class="p">(</span><span class="n">mesh_S</span><span class="p">,</span> 
                                                                                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                                                                    <span class="n">rescale_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># cMCF is solved in normalized coordinates, when True, the output will be rescaled to be in image coordinates.  </span>
                                                                                    <span class="n">delta</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> 
                                                                                    <span class="n">conformalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># set this flag to run cMCF, else it will run MCF</span>
                                                                                    <span class="n">robust_L</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># if set, runs MCF/cMCF using the robust Laplacian instead of cotangent Laplacian</span>
                                                                                    <span class="n">mollify_factor</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="c1"># this is a parameter used in the robust Laplacian</span>
                                                                                    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">)</span>  <span class="c1"># &#39;scipy&#39;: standard scipy solver, &#39;pardiso&#39; for using Intel&#39;s pardiso solver to solve in parallel. &#39;pariso&#39; is much faster. But you must use &#39;scipy&#39; if you plan to multiprocess over different cells.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Save the iterations</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># save the vertex positions with face connectivity</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">),</span> 
              <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">Usteps_MCF_img</span><span class="p">,</span> <span class="c1"># rescaled image coordinates, since we ran with rescale_output=True(default)</span>
               <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="n">mesh_F</span><span class="p">})</span> <span class="c1"># face connectivity</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 50/50 [02:55&lt;00:00,  3.51s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Use discrete gaussian curvature to find first changepoint</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">gauss_curve_MCF</span> <span class="o">=</span> <span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;gauss_curvature_iter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">inds</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">find_all_curvature_cutoff_index</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">,</span> 
                                                 <span class="n">avg_fnc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="c1"># use moving means </span>
                                                 <span class="n">absval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># absolute value after subtracting baseline </span>
                                                 <span class="n">winsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="c1"># window size for moving means, larger tends to slightly bias the found iteration number to later </span>
                                                 <span class="n">min_peak_height</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="c1"># minimum peak height</span>
                                                 <span class="n">min_peak_distance</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># minimal distance between detected peaks. </span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;possible iteration numbers for reference shape:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using the first as the reference. :&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Construct the mesh at the found changepoint</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">cMCF_mesh_S</span> <span class="o">=</span> <span class="n">mesh_S</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span> <span class="n">cMCF_mesh_S</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_mesh_S</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                                      <span class="s1">&#39;cMCF_mesh_S.obj&#39;</span><span class="p">))</span>

<span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
<span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;inds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span>

<span class="c1"># save the convergence measures. We computed several but found the mean absolute discrete Gaussian curvature (&lt;|K|&gt;) to best serve as a &#39;shape state&#39; parameter</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_convergence_measures_&#39;</span><span class="o">+</span><span class="n">basefname</span> <span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">),</span>
                           <span class="n">MCF_measures_dict</span><span class="p">)</span> 


<span class="c1"># make a plot and save in the folder</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> 
          <span class="n">gauss_curve_MCF</span><span class="p">,</span> <span class="s1">&#39;.-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">),</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration Number&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. Gaussian Curvature&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">)),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>possible iteration numbers for reference shape:
[ 6 27]
using the first as the reference. :
6
</pre></div>
</div>
<img alt="../../_images/168b4ea17d8c38060eaf2b43a67a180f34f7f5a6947ec50aaf72b6fc3fe65d3e.png" src="../../_images/168b4ea17d8c38060eaf2b43a67a180f34f7f5a6947ec50aaf72b6fc3fe65d3e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">check for genus-0, using Euler number (i.e. euler number == 2), if not satisfied run shrinkwrapping</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">if</span> <span class="n">cMCF_mesh_S</span><span class="o">.</span><span class="n">euler_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
    <span class="c1"># skip the shrinkwrapping and go to voxelization </span>
    <span class="n">genus0_cMCF_mesh</span> <span class="o">=</span> <span class="n">cMCF_mesh_S</span>

<span class="k">else</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run shrinkwrapping to get genus-0 version </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># we can lower number when the shape is simple, as here, or let it be higher to see if we can get better wrap than initial</span>
    <span class="n">decay_rate</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">min_lr</span> <span class="o">=</span> <span class="mf">0.24</span> <span class="c1"># for decay_rate 0.5, this would mean lowest is 0.25.</span>

    <span class="n">n_punchout_refinements</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Set this &gt;0 to run shrinkwrapping step 3 - step 2 loop n times for complex shapes with nasty concavities. Not needed here.</span>

    <span class="c1"># one round is largely sufficient for most cMCF Sref shapes as by definition they should have concavities largely removed. </span>
    <span class="n">mesh_shrinkwrap</span><span class="p">,</span> <span class="n">mesh_watertight_in</span><span class="p">,</span> <span class="n">mesh_genus0</span><span class="p">,</span> <span class="n">iter_stats</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">shrinkwrap_genus0_basic</span><span class="p">(</span><span class="n">cMCF_mesh_S</span><span class="p">,</span> 
                                                                                                    <span class="n">use_GVF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                                                    <span class="n">GVF_mu</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                                                                                                    <span class="n">GVF_iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                                                                                    <span class="n">voxelize_padsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                                                                                    <span class="n">voxelize_dilate_ksize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># make dilate_ksize &gt; erode_ksize if your mesh doesn&#39;t form a complete volume or there is quite a bit of holes.</span>
                                                                                                    <span class="n">voxelize_erode_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  
                                                                                                    <span class="n">extra_pad</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_alpha_frac</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span> <span class="c1"># default</span>
                                                                                                    <span class="n">genus0_alpha_auto</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_tol</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> 
                                                                                                    <span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="n">total_shrinkwrap_iters</span><span class="p">,</span>
                                                                                                    <span class="n">decay_rate</span> <span class="o">=</span> <span class="n">decay_rate</span><span class="p">,</span>  
                                                                                                    <span class="n">remesh_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                                                    <span class="n">conformalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># use active contours - recommended </span>
                                                                                                    <span class="n">min_size</span><span class="o">=</span><span class="mf">40e3</span><span class="p">,</span> <span class="c1"># minimum mesh vertices, increase might better cover smaller cavities but greatly increase computational time!</span>
                                                                                                    <span class="n">upsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                    <span class="n">min_lr</span><span class="o">=</span><span class="n">min_lr</span><span class="p">,</span> <span class="c1"># minimum step_size dropping from 1.</span>
                                                                                                    <span class="n">make_manifold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># run this. </span>
                                                                                                    <span class="n">watertight_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                                                    <span class="n">deltaL</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
                                                                                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># controls stiffness</span>
                                                                                                    <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="c1"># controls torsion</span>
                                                                                                    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">,</span>
                                                                                                    <span class="n">curvature_weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                                                                    <span class="n">debugviz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># leave on if you want to see the state of the mesh, otherwise off. </span>
            
    <span class="c1"># save out the output for visualization and checking </span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                                            <span class="s1">&#39;shrinkwrap_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span> <span class="c1"># this should be same as the last iteration mesh.</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_watertight_in</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                                <span class="s1">&#39;input_Sref_to_shrinkwrapping_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_genus0</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                                        <span class="s1">&#39;initial_genus0_shrinkwrap_Sref_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span>
                                                <span class="s1">&#39;shrinkwrap_final-iter_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>


    <span class="c1"># setup save variables ready for step 3 processing. [those stats will append to these]</span>
    <span class="n">chamfer_dists</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">all_meshes_iter_genus0</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># this completes the euler number for each iteration - you can check this is 2.</span>
    <span class="n">all_meshes_iter</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
    <span class="c1"># step 3 shrinkwrap code, executed only if n_punchout_refinements&gt;0</span>
    <span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># run this a few times. </span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_punchout_refinements</span><span class="p">):</span> <span class="c1"># use more iterations until happy </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1. detect nonconverged. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">remove_nonshrinkwrap_triangles</span><span class="p">(</span><span class="n">mesh_wrap</span><span class="p">,</span>
                                                            <span class="n">cMCF_mesh_S</span><span class="p">,</span>
                                                            <span class="n">q_thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                            <span class="n">max_dist_cutoff</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="c1"># this controls the fidelity... </span>
                                                            <span class="n">sigma_dist_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                                            <span class="n">sigma_area_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># this ? </span>
                                                            <span class="n">nearest_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">dilate_voxels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># cut more away ? </span>
                                                            <span class="n">erode_voxels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">minsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2. re-prop surface. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh_shrinkwrap</span><span class="p">,</span> <span class="n">mesh_watertight_in</span><span class="p">,</span> <span class="n">mesh_genus0</span><span class="p">,</span> <span class="n">iter_stats</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">attract_surface_mesh</span><span class="p">(</span><span class="n">mesh_in</span><span class="o">=</span><span class="n">mesh_wrap</span><span class="p">,</span>
                                                                                                            <span class="n">mesh_ref</span><span class="o">=</span><span class="n">cMCF_mesh_S</span><span class="p">,</span> 
                                                                                                            <span class="n">use_GVF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                                                            <span class="n">GVF_mu</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># this large, introduces noise </span>
                                                                                                            <span class="n">GVF_iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                                                                        <span class="n">voxelize_padsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1"># this is just leave enough padding space </span>
                                                                                                        <span class="n">voxelize_dilate_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                                                                        <span class="n">voxelize_erode_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">## was this cos of 3? </span>
                                                                                                        <span class="n">extra_pad</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                                                        <span class="n">tightest_genus0_initial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                                                        <span class="n">genus0_alpha_frac</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                                        <span class="n">genus0_alpha_auto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                                                                        <span class="n">genus0_offset</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                                        <span class="n">genus0_tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
                                                                                                        <span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="c1"># master number of iterations.</span>
                                                                                                        <span class="n">decay_rate</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="c1"># no decay. </span>
                                                                                                        <span class="n">remesh_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                                                        <span class="n">conformalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># use active contours</span>
                                                                                                        <span class="n">min_size</span><span class="o">=</span><span class="mi">80000</span><span class="p">,</span> <span class="c1"># minimum mesh vertices</span>
                                                                                                        <span class="n">upsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                        <span class="n">min_lr</span><span class="o">=</span><span class="n">min_lr</span><span class="p">,</span> <span class="c1"># minimum step_size dropping from 1.</span>
                                                                                                        <span class="n">make_manifold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># ah.. its prob this too. </span>
                                                                                                        <span class="n">watertight_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                                                        <span class="n">deltaL</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
                                                                                                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># more stiff here and we can break through? </span>
                                                                                                        <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="c1"># what if we reduce the bending? </span>
                                                                                                        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">,</span>
                                                                                                        <span class="n">curvature_weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                                                                        <span class="n">debugviz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">all_meshes_iter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">all_meshes_iter_genus0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">chamfer_dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        insert save if you want to check </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># here, i&#39;m going to rewrite the previous final iteration shrinkwrap. checking how good this is, is a good general indicator if we need more refinement iterations i.e. increase the number of loops</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span>
                                                <span class="s1">&#39;shrinkwrap_final-iter_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
        
        <span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="c1"># flatten all of it </span>
    <span class="k">if</span> <span class="n">n_punchout_refinements</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">all_meshes_iter_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">all_meshes_iter_item</span> <span class="ow">in</span> <span class="n">all_meshes_iter</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_meshes_iter_item</span><span class="p">]</span>
        <span class="n">all_meshes_iter_genus0_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">all_meshes_iter_item</span> <span class="ow">in</span> <span class="n">all_meshes_iter_genus0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_meshes_iter_item</span><span class="p">]</span>
        <span class="n">all_chamfer_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">chamfer_dists</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_meshes_iter_flat</span> <span class="o">=</span> <span class="n">all_meshes_iter</span>
        <span class="n">all_meshes_iter_genus0_flat</span> <span class="o">=</span> <span class="n">all_meshes_iter_genus0</span>
        <span class="n">all_chamfer_dists</span> <span class="o">=</span> <span class="n">chamfer_dists</span>


    <span class="c1"># we take the mesh with lowest chamfer distance to the input surface as the genus-0 $S_\text{ref}$</span>
    <span class="n">final_mesh</span> <span class="o">=</span> <span class="n">all_meshes_iter_flat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">all_chamfer_dists</span><span class="p">)]</span>

    <span class="c1"># we isotropically remesh this output to ensure good triangle quality [optional if running voxelization after]</span>
    <span class="n">final_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">incremental_isotropic_remesh</span><span class="p">(</span><span class="n">final_mesh</span><span class="p">)</span>

    <span class="c1"># save the final mesh</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">final_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span>
                                        <span class="s1">&#39;final_shrinkwrap_</span><span class="si">%s</span><span class="s1">_cMCF_Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>

    <span class="n">genus0_cMCF_mesh</span> <span class="o">=</span> <span class="n">final_mesh</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">voxelize the reference to create a dilated version just in case there are thin necks etc that effect precision</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">Sref_img_binary</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">voxelize_image_mesh_pts</span><span class="p">(</span><span class="n">genus0_cMCF_mesh</span><span class="p">,</span> <span class="c1"># might be best here to use barycenter </span>
                                                    <span class="n">dilate_ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># this is the size of the ball kernel to plug holes and handles. </span>
                                                    <span class="n">erode_ksize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># make this smaller than erode_ksize to have it more dilated. </span>
                                                    <span class="n">vol_shape</span><span class="o">=</span><span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># If you know your image shape, specify the vol_shape for better speed, otherwise use None The ::-1, is because S(x,y,z) was extracted from a transposed version of the cell binary</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Re-extraction of surface mesh to obtain the final genus-0 $S_{\text{ref}(x,y,z)} for spherical parameterization </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">cMCF_Sref_remesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">marching_cubes_mesh_binary</span><span class="p">(</span><span class="n">Sref_img_binary</span><span class="p">,</span> 
                                                        <span class="n">presmooth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
                                                        <span class="n">contourlevel</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> 
                                                        <span class="n">remesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                        <span class="n">remesh_method</span><span class="o">=</span><span class="s1">&#39;CGAL&#39;</span><span class="p">,</span> 
                                                        <span class="n">remesh_samples</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="c1"># lower downsampling will give a coarser mesh, which is easier to get equiareal spherical parameterization but may lose accuracy in representing high-curvature protrusive features (if present).</span>
                                                        <span class="n">predecimate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># only essential if remesh_method=&#39;pyacvd </span>
                                                        <span class="n">min_mesh_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>  

<span class="c1"># check this remesh gives a genus-0 mesh</span>
<span class="n">mesh_property</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">measure_props_trimesh</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="p">,</span> <span class="n">main_component</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">mesh_property</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initial: -8
initial_watertight: -8
</pre></div>
</div>
<img alt="../../_images/7410d72f8fb7529c9ab03cfc8e4b3a66f5bbb91e376a1b57ef80a0bcfba7b89d.png" src="../../_images/7410d72f8fb7529c9ab03cfc8e4b3a66f5bbb91e376a1b57ef80a0bcfba7b89d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initiating a genus-0 mesh automatically with interval:  [4.089280543163532, 4.090029428233311]
</pre></div>
</div>
<img alt="../../_images/9cd6968b419ae05f5342e4a7fdfbc7ac0cf8022b61f8f404a5dc4b5a72348d27.png" src="../../_images/9cd6968b419ae05f5342e4a7fdfbc7ac0cf8022b61f8f404a5dc4b5a72348d27.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GVF iter: 15/15(85138, 3)
</pre></div>
</div>
<img alt="../../_images/3bb8b5d85d111338df2c41ae66093de6a4b4b8f45157d8becd3e2010e3ee7573.png" src="../../_images/3bb8b5d85d111338df2c41ae66093de6a4b4b8f45157d8becd3e2010e3ee7573.png" />
<img alt="../../_images/b09ff27e58472eae2e5d1910a7ebc199ba0eba1f9587742ab6db3462e98ba703.png" src="../../_images/b09ff27e58472eae2e5d1910a7ebc199ba0eba1f9587742ab6db3462e98ba703.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
0 4.335801012103417 changing lr:  0.75
0 4.335801012103417
1
==========================
2
--------------------------
1 4.181890749681781
2
==========================
2
--------------------------
2 4.185436085143376 changing lr:  0.5625
2 4.185436085143376
3
==========================
2
--------------------------
3 3.9930898599566857
4
==========================
2
--------------------------
4 3.9946050038377106 changing lr:  0.421875
4 3.9946050038377106
5
==========================
2
--------------------------
5 3.7645453859583236
6
==========================
2
--------------------------
6 3.751325306497133
7
==========================
2
--------------------------
7 3.730496783846444
8
==========================
2
--------------------------
8 3.6581404286493173
9
==========================
2
--------------------------
9 3.6717814131564466 changing lr:  0.31640625
9 3.6717814131564466
{&#39;convex&#39;: False, &#39;volume&#39;: True, &#39;watertight&#39;: True, &#39;orientability&#39;: True, &#39;euler_number&#39;: 2, &#39;genus&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># transfer the curvature from cMCF to the genus-0 cMCF</span>

<span class="n">match_params</span><span class="p">,</span> <span class="n">surf_H_Sref_remesh</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">transfer_mesh_measurements</span><span class="p">(</span><span class="n">cMCF_mesh_S</span><span class="p">,</span> 
                                                                        <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
                                                                        <span class="n">source_mesh_vertex_scalars</span><span class="o">=</span><span class="n">surf_H</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>
<span class="n">surf_H_Sref_remesh</span> <span class="o">=</span> <span class="n">surf_H_Sref_remesh</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

<span class="n">surf_H_Sref_remesh_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">surf_H_Sref_remesh</span><span class="o">/</span><span class="n">voxel_size</span><span class="p">,</span>
                                                  <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">,</span>
                                                  <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mf">255.</span><span class="o">*</span><span class="n">surf_H_Sref_remesh_colors</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>        

<span class="c1"># save this mesh for unwrapping </span>
<span class="n">save_smooth_remesh_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                                     <span class="s1">&#39;unwrap_cMCF_Sref_mesh.obj&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">save_smooth_remesh_file</span><span class="p">)</span>

<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_cMCF</span><span class="p">,</span> 
                          <span class="s1">&#39;curvature_stats_genus0_Sref.mat&#39;</span><span class="p">),</span>
                          <span class="p">{</span><span class="s1">&#39;surf_H&#39;</span><span class="p">:</span> <span class="n">surf_H</span><span class="p">,</span>
                           <span class="s1">&#39;surf_H_remapped&#39;</span><span class="p">:</span> <span class="n">surf_H_Sref_remesh</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="conformal-spherical-parameterization">
<h2>2. Conformal Spherical parameterization<a class="headerlink" href="#conformal-spherical-parameterization" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_conformal</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                    <span class="s1">&#39;Step2_conformal_sphere&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_conformal</span><span class="p">)</span>

<span class="n">sphere_xyz_iterative</span><span class="p">,</span> <span class="n">n_inverted_faces</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">iterative_tutte_spherical_map</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
                                                                                 <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> 
                                                                                <span class="n">deltaL</span> <span class="o">=</span> <span class="mf">5e-3</span><span class="p">,</span> <span class="c1"># like the cMCF, controls speed of convergence. </span>
                                                                                <span class="n">min_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># return as soon as iteration number &gt; min_iter, and number of inverted faces is 0  </span>
                                                                                <span class="n">max_iter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="c1"># run this many iterations to see if number of inverted reduces to 0</span>
                                                                                <span class="n">mollify_factor</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> 
                                                                                <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="c1"># gives just the vertices.</span>

<span class="k">assert</span><span class="p">(</span><span class="n">n_inverted_faces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>

<span class="n">conformal_sphere_mesh</span> <span class="o">=</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">conformal_sphere_mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">sphere_xyz_iterative</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">conformal_sphere_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_conformal</span><span class="p">,</span>
                                                <span class="s1">&#39;conformal_sphere_param_Sref_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="equiareal-spherical-parameterization">
<h2>3. Equiareal Spherical parameterization<a class="headerlink" href="#equiareal-spherical-parameterization" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_equiareal</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                    <span class="s1">&#39;Step3_equiareal_sphere&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_equiareal</span><span class="p">)</span>


<span class="c1"># use a lot more iterations just in case. </span>
<span class="n">relax_v</span><span class="p">,</span> <span class="n">relax_f</span><span class="p">,</span> <span class="n">area_distortion_iter</span><span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">area_distortion_flow_relax_sphere</span><span class="p">(</span><span class="n">conformal_sphere_mesh</span><span class="p">,</span> 
                                                                                    <span class="n">cMCF_Sref_remesh</span><span class="p">,</span> 
                                                                                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="c1"># this needs to be increased the more S_ref deviates from spherical. </span>
                                                                                    <span class="n">delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># controls the stiffness, if too high - there is no flow, if too low - bijectivity is lost and flow may breakdown </span>
                                                                                    <span class="n">stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                    <span class="n">debugviz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

<span class="c1"># compute the evolution of the mean area distortion. We use this to determine the first iteration when area distortion is minimized. </span>
<span class="n">area_distortion_iter_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">area_distortion_iter</span><span class="p">])</span>

<span class="c1"># to determine when area distortion is minimised we look for the timepoint when the sign first changes. This is because once the minimum is reached, depending on stepsize, the mesh will start to oscilate. The larger the stepsize, the faster the convergence but the larger the oscillatory instability. </span>
<span class="n">min_area_distort</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># falls below 0. </span>

<span class="c1"># check: print the area distortion value at min_area_distort. This should be close to 1 (the ideal minimum) for optimal relaxation.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;distortion at found iteration number:&#39;</span><span class="p">,</span> <span class="n">area_distortion_iter_curve</span><span class="p">[</span><span class="n">min_area_distort</span><span class="p">])</span>


<span class="c1"># the area_distortion_iter_curve is another great check of things are working, we plot the np.log(curve) to visualize a log scale.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">),</span> <span class="s1">&#39;.-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">min_area_distort</span><span class="p">,</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">)),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">)),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">area_distortion_iter_curve</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration Number&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Area distortion&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_equiareal</span><span class="p">,</span> 
                          <span class="s1">&#39;area-distortion_relax_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">)),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># create the equiareal mesh and save it out</span>
<span class="n">equiareal_sphere_mesh</span> <span class="o">=</span> <span class="n">conformal_sphere_mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">equiareal_sphere_mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">relax_v</span><span class="p">[</span><span class="n">min_area_distort</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">equiareal_sphere_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_equiareal</span><span class="p">,</span>
                                               <span class="s1">&#39;equiareal_sphere_param_Sref_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 40%|███▉      | 199/500 [00:32&lt;00:57,  5.25it/s]c:\Users\fyz11\anaconda3\envs\u_Unwrap3D\lib\site-packages\numpy\lib\nanfunctions.py:1217: RuntimeWarning: All-NaN slice encountered
  return function_base._ureduce(a, func=_nanmedian, keepdims=keepdims,
100%|██████████| 500/500 [02:27&lt;00:00,  3.39it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>distortion at found iteration number: 1.0011870301928216
</pre></div>
</div>
<img alt="../../_images/381971443fb8069ff17ce05fb7125d894ba7eb7232d56fcebcde3c63e838c891.png" src="../../_images/381971443fb8069ff17ce05fb7125d894ba7eb7232d56fcebcde3c63e838c891.png" />
</div>
</div>
</section>
<section id="uv-map">
<h2>4. UV map<a class="headerlink" href="#uv-map" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_uv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                             <span class="s1">&#39;Step4_uv_map&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_uv</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Optimize rotation for positive protrusions accounting for both Sref and S.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">curvature_cutoff_voxels</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># Compute mean curvature of S_ref </span>
<span class="n">H_Sref</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">compute_mean_curvature</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Threshold the above by cutoff together with that of the S</span>
<span class="n">H_S</span> <span class="o">=</span> <span class="n">surf_H_Sref_remesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="n">binary_H_Sref</span> <span class="o">=</span> <span class="n">H_Sref</span> <span class="o">&gt;</span> <span class="n">curvature_cutoff_voxels</span>
<span class="n">binary_H_S</span> <span class="o">=</span> <span class="n">H_S</span> <span class="o">&gt;</span> <span class="n">curvature_cutoff_voxels</span>

<span class="c1"># define weights as the absolute value of curvature</span>
<span class="n">weighting_for_S</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">weighting_for_S</span><span class="p">)</span><span class="o">*</span><span class="n">binary_H_Sref</span><span class="o">+</span><span class="n">weighting_for_S</span><span class="o">*</span><span class="n">binary_H_S</span>
<span class="n">weights_proj</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># this is a signed i.e. has +/- values to resolve the ambiguity of putting the </span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Weighted Eigendecomposition to solve for the optimal rotation </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">rot_matrix</span><span class="p">,</span> <span class="n">extra_rotate_bool</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">optimize_sphere_rotation_from_weights</span><span class="p">(</span><span class="n">equiareal_sphere_mesh</span><span class="p">,</span> 
                                                                                <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> 
                                                                                <span class="n">signed_weights_to_orient</span><span class="o">=</span><span class="n">weights_proj</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Apply optimized rotation matrix to equiareal_sphere_mesh</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">equiareal_sphere_mesh_rot_combined</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">apply_optimized_sphere_rotation_from_weights</span><span class="p">(</span><span class="n">equiareal_sphere_mesh</span><span class="p">,</span> 
                                                                                    <span class="n">rot_matrix</span><span class="p">,</span> 
                                                                                    <span class="n">extra_rotate_bool</span><span class="p">,</span>
                                                                                    <span class="n">additional_rotation_angle_degrees</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">uv map and visualize curvature of S to check </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Perform the unwrap, and map the curvature color of S to check</span>
<span class="c1"># use length ratio aspect ratio optimization </span>
<span class="n">S_uv_opt</span><span class="p">,</span> <span class="n">uv_Sref_equiareal_match_rot</span><span class="p">,</span> <span class="n">h_opt</span><span class="p">,</span> <span class="n">H_color</span><span class="p">,</span> <span class="n">uv_surface_measurements_labels</span> <span class="o">=</span> <span class="n">uzip</span><span class="o">.</span><span class="n">uv_map_sphere_surface_parameterization</span><span class="p">(</span><span class="n">sphere_mesh</span><span class="o">=</span><span class="n">equiareal_sphere_mesh_rot_combined</span><span class="p">,</span> 
                                                                                                                                    <span class="n">surface_mesh</span><span class="o">=</span><span class="n">cMCF_Sref_remesh</span><span class="p">,</span>
                                                                                                                                    <span class="n">surface_measurements_scalars</span><span class="o">=</span><span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mf">1.</span><span class="p">,</span> <span class="c1"># make sure its float.</span>
                                                                                                                                    <span class="n">surface_measurements_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                                                                                    <span class="n">uv_grid_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> 
                                                                                                                                    <span class="n">optimize_aspect_ratio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Set true if you want to optimize the number of columns  </span>
                                                                                                                                    <span class="n">aspect_ratio_method</span><span class="o">=</span><span class="s1">&#39;length_ratio&#39;</span><span class="p">,</span> <span class="c1"># method for optimizing aspect ratio.</span>
                                                                                                                                    <span class="n">length_ratio_avg_fn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">,</span>
                                                                                                                                    <span class="n">h_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">H_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">H_color</span><span class="p">)</span> <span class="c1"># convert back to uint8 for visualization</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;uv mapped curvature color&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">H_color</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># save the parameters of the map</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_uv</span><span class="p">,</span> 
                          <span class="s1">&#39;uv_mapping_params.mat&#39;</span><span class="p">),</span>
             <span class="p">{</span><span class="s1">&#39;uv_map&#39;</span> <span class="p">:</span> <span class="n">S_uv_opt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
              <span class="s1">&#39;uv_mesh_match_tri_inds&#39;</span><span class="p">:</span> <span class="n">uv_Sref_equiareal_match_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="s1">&#39;uv_mesh_match_barycenter_weights&#39;</span><span class="p">:</span> <span class="n">uv_Sref_equiareal_match_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="s1">&#39;rot_matrix&#39;</span><span class="p">:</span> <span class="n">rot_matrix</span><span class="p">,</span> 
              <span class="s1">&#39;extra_rotate_bool&#39;</span><span class="p">:</span> <span class="n">extra_rotate_bool</span><span class="p">,</span>
              <span class="s1">&#39;equiareal_vertices&#39;</span><span class="p">:</span> <span class="n">equiareal_sphere_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
              <span class="s1">&#39;equiareal_faces&#39;</span><span class="p">:</span> <span class="n">equiareal_sphere_mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
              <span class="s1">&#39;weights&#39;</span> <span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
              <span class="s1">&#39;weights_proj&#39;</span><span class="p">:</span> <span class="n">weights_proj</span><span class="p">})</span>


<span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_uv</span><span class="p">,</span>
                         <span class="s1">&#39;uv_H_color.tif&#39;</span><span class="p">),</span>
                         <span class="n">H_color</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/400660a837f4f0efe9660b90763e6f03416e660ca29ffac42b28a8a495f9d831.png" src="../../_images/400660a837f4f0efe9660b90763e6f03416e660ca29ffac42b28a8a495f9d831.png" />
</div>
</div>
</section>
<section id="build-topography-space">
<h2>5. Build Topography space<a class="headerlink" href="#build-topography-space" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_topo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                               <span class="s1">&#39;Step5_topography_space&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_topo</span><span class="p">)</span>

<span class="n">S_mesh_pts</span> <span class="o">=</span> <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">topography_space</span><span class="p">,</span> <span class="p">(</span><span class="n">N_in</span><span class="p">,</span> <span class="n">N_out</span><span class="p">),</span> <span class="n">alpha_step</span> <span class="o">=</span> <span class="n">uzip</span><span class="o">.</span><span class="n">build_topography_space_from_Suv</span><span class="p">(</span><span class="n">S_uv_opt</span><span class="p">,</span> 
                                                                                    <span class="n">Sref_img_binary</span><span class="p">,</span>
                                                                                    <span class="n">external_gradient_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># build if none, using Euclidean distance transform</span>
                                                                                    <span class="n">pad_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                                                                    <span class="n">alpha_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># use automatic method</span>
                                                                                    <span class="n">outer_surf_pts</span> <span class="o">=</span> <span class="n">S_mesh_pts</span><span class="p">,</span>
                                                                                    <span class="n">outer_n_dists</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># let this be auto determined. </span>
                                                                                    <span class="n">outer_pad_dist</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># the leeway.</span>
                                                                                    <span class="n">outer_method</span><span class="o">=</span><span class="s1">&#39;forward_euler&#39;</span><span class="p">,</span>
                                                                                    <span class="n">outer_smooth_win_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="c1"># we will smooth by minimum length of uv divide this factor. </span>
                                                                                    <span class="n">inner_n_dists</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="c1"># in voxels.</span>
                                                                                    <span class="n">inner_sdf_method</span> <span class="o">=</span> <span class="s1">&#39;harmonic&#39;</span><span class="p">,</span>
                                                                                    <span class="n">inner_source_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                                                                                    <span class="n">inner_harmonic_ds</span> <span class="o">=</span> <span class="mf">4.</span><span class="p">,</span> <span class="c1"># harmonic distance transform is memory-intensive and slow. Nearly always we must downsample so the volume is at most 256 x 256 x 256 voxels. 4x downsample by default. </span>
                                                                                    <span class="n">inner_method</span><span class="o">=</span><span class="s1">&#39;active_contours&#39;</span><span class="p">)</span>

<span class="c1"># check what is the dimensions of the topographic space</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;topographic space dimension: &#39;</span><span class="p">,</span> <span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the first </span><span class="si">%d</span><span class="s1"> slices are interior of S_ref&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">N_in</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the next </span><span class="si">%d</span><span class="s1"> slices are exterior of S_ref&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">N_out</span><span class="p">))</span>

<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_topo</span><span class="p">,</span> 
                          <span class="s1">&#39;topographic_volume_space.mat&#39;</span><span class="p">),</span> 
             <span class="p">{</span><span class="s1">&#39;topographic_map&#39;</span><span class="p">:</span> <span class="n">topography_space</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
              <span class="s1">&#39;uv_map&#39;</span><span class="p">:</span> <span class="n">S_uv_opt</span><span class="p">,</span> 
              <span class="s1">&#39;N_inside&#39;</span><span class="p">:</span> <span class="n">N_in</span><span class="p">,</span> 
              <span class="s1">&#39;N_outside&#39;</span><span class="p">:</span> <span class="n">N_out</span><span class="p">,</span>
              <span class="s1">&#39;alpha_step&#39;</span><span class="p">:</span> <span class="n">alpha_step</span><span class="p">})</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 36/36 [00:05&lt;00:00,  6.31it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>laplacian 3D construction... 3.183608293533325
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 25/25 [00:09&lt;00:00,  2.69it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>topographic space dimension:  (62, 256, 422, 3)
the first 25 slices are interior of S_ref
the next 36 slices are exterior of S_ref
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-topographic-surface">
<h2>6. Extract topographic surface<a class="headerlink" href="#extract-topographic-surface" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">savefolder_topo_mesh</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                <span class="s1">&#39;Step6_topography_mesh&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder_topo_mesh</span><span class="p">)</span>

<span class="c1"># map the cell binary</span>
<span class="n">topographic_binary</span> <span class="o">=</span> <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)[</span><span class="o">...</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                                                    <span class="n">grid_shape</span><span class="o">=</span><span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                    <span class="n">I_ref</span><span class="o">=</span><span class="p">(</span><span class="n">mesh_S_binary</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">255.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">topographic_binary</span> <span class="o">=</span> <span class="n">topographic_binary</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<span class="c1"># visualize the mid cross sections of topographic binary as check </span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Topographic binary mid cross-sections&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[</span><span class="n">topographic_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[:,</span><span class="n">topographic_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[:,:,</span><span class="n">topographic_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5d7bee9bae5410c25a7d279d8f616f69bf18d898d32851a9781fa692ed3c7c1f.png" src="../../_images/5d7bee9bae5410c25a7d279d8f616f69bf18d898d32851a9781fa692ed3c7c1f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we mesh and keep the largest connected component</span>
<span class="n">topographic_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">marching_cubes_mesh_binary</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">,</span>   
                                                        <span class="n">presmooth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="c1"># applies a presmooth</span>
                                                        <span class="n">contourlevel</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="c1"># isosurface level to mesh</span>
                                                        <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># we want the largest connected component </span>
                                                        <span class="n">remesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">remesh_method</span><span class="o">=</span><span class="s1">&#39;CGAL&#39;</span><span class="p">,</span> 
                                                        <span class="n">remesh_samples</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="c1"># remeshing with a target #vertices = 50% of original</span>
                                                        <span class="n">predecimate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># must be True if using remesh_method=&#39;pyacvd&#39;</span>
                                                        <span class="n">min_mesh_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                                        <span class="n">upsamplemethod</span><span class="o">=</span><span class="s1">&#39;inplane&#39;</span><span class="p">)</span> <span class="c1"># upsample the mesh if after the simplification and remeshing &lt; min_mesh_size  </span>

<span class="c1"># check the orientation</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">topographic_mesh</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">topographic_mesh</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">topographic_mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Compute and map curvature to topography mesh</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># compute curvature 3D and sample onto the topographic mesh</span>
<span class="n">topography_verts_xyz</span> <span class="o">=</span> <span class="n">topo_tools</span><span class="o">.</span><span class="n">uv_depth_pts3D_to_xyz_pts3D</span><span class="p">(</span> <span class="n">topographic_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                               <span class="n">topography_space</span><span class="p">)</span>


<span class="c1"># Compute the continuous mean curvature from the binary cell segmentation as for S(x,y,z) </span>
<span class="n">H_binary</span><span class="p">,</span> <span class="n">H_sdf_vol_normal</span><span class="p">,</span> <span class="n">H_sdf_vol</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">mean_curvature_binary</span><span class="p">(</span><span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
                                                                           <span class="n">smooth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                                                           <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># if mask=True, only the curvature of a thin shell (+/-smooth) around the binary segmentation is returned. </span>

<span class="c1"># interpolate the value onto the topographic mesh. Note: inversion of points to match the image dimensions (the mesh was derived after transposing the binary)</span>
<span class="n">topo_surf_H</span> <span class="o">=</span> <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">topography_verts_xyz</span><span class="p">,</span> 
                                            <span class="n">grid_shape</span><span class="o">=</span> <span class="n">H_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                            <span class="n">I_ref</span><span class="o">=</span> <span class="n">H_binary</span><span class="p">,</span> 
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> 
                                            <span class="n">cast_uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># we generate colors from the mean curvature </span>
<span class="n">topo_surf_H_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">topo_surf_H</span><span class="o">/</span><span class="n">voxel_size</span><span class="p">,</span> <span class="c1"># 0.104 is the voxel resolution -&gt; this converts to um^-1 </span>
                                          <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">,</span> 
                                          <span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span> 
                                          <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="c1"># colormap H with lower and upper limit of -1, 1 um^-1. </span>

<span class="c1"># set the vertex colors to the computed mean curvature color</span>
<span class="n">topographic_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">topo_surf_H_colors</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span> 

<span class="c1"># save the mesh for viewing in an external program such as meshlab which offers much better rendering capabilities</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">topographic_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_topo_mesh</span><span class="p">,</span> 
                                           <span class="s1">&#39;curvature_topographic_mesh_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span><span class="p">))</span> <span class="c1"># tmp is used to prevent printing to screen.</span>


<span class="c1"># also save the remapped cell binary too </span>
<span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder_topo_mesh</span><span class="p">,</span> 
                         <span class="s1">&#39;topography_binary.tif&#39;</span><span class="p">),</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mf">255.</span><span class="o">*</span><span class="n">topographic_binary</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./03_basic_workflow\full_example_cells"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="unwrap_bleb_cell.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Example 1: Cell with blebs</p>
      </div>
    </a>
    <a class="right-next"
       href="unwrap_filopodia_cell.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Example 3: Cell with filopodia</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-the-surface-mesh">0. Read in the surface mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-cmcf-to-get-reference-shape">1. run cMCF to get reference shape</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conformal-spherical-parameterization">2. Conformal Spherical parameterization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#equiareal-spherical-parameterization">3. Equiareal Spherical parameterization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uv-map">4. UV map</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-topography-space">5. Build Topography space</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-topographic-surface">6. Extract topographic surface</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Felix Y. Zhou
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://github.com/fyz11/u-Unwrap3D_notebooks/blob/main/LICENSE" target="_blank">GPL3</a> unless mentioned otherwise. 
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>