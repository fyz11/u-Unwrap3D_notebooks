
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Step 1: Find and create a genus-0 reference surface, \(S_{ref}(x,y,z)\) &#8212; u-Unwrap3D Analysis Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_basic_workflow/Step1_find_reference_surface';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, \(S_{ref}(x,y,z)\)" href="Step2_quasiconformal_spherical_parameterization.html" />
    <link rel="prev" title="Step 0: Segmenting a single cell from a volume image" href="Step0_find_cell_surface_from_segmentation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">u-Unwrap3D Analysis Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    u-Unwrap3D Analysis Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_installation/readme.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Standard Workflow</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Standard workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step0_find_cell_surface_from_segmentation.html">Step 0: Segmenting a single cell from a volume image</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Step 1: Find and create a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step2_quasiconformal_spherical_parameterization.html">Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step3_equiareal_spherical_parameterization.html">Step 3: Quasi-equiareal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step4_uv_mapping_spherical_parameterization.html">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> into 2D using its spherical parameterization, <span class="math notranslate nohighlight">\(S_{\text{ref}}^{\Omega}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step5_building_topography_surface.html">Step 5: Building the topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step6_find_topographic_surface_mesh.html">Step 6: Compute topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> from topographic binary segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step7_topographic_cMCF_to_flatten.html">Step 7: Flattening the topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> onto the 2D plane</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="full_example_cells/readme.html">Full examples of standard workflow</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_bleb_cell.html">Example 1: Cell with blebs</a></li>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_lamellipodia_cell.html">Example 2: Cell with lamellipodia</a></li>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_filopodia_cell.html">Example 3: Cell with filopodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Customizing the standard workflow to input data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_customizing_basic_workflow/readme.html">Customizing the standard workflow for downstream analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">In-depth Breakdown of Mapping Steps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_obtaining_surfaces/readme.html">Extracting surfaces from microscopy imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_find_reference_surface/readme.html">Finding the best reference shape for the analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_uv_parameterization/readme.html">UV unwrapping of spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_building_topography_space/readme.html">Building topography space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_spherical_parameterization/readme.html">Spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_flatten_topography_surface/readme.html">Flattening topography surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transporting measurements between representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../22_transporting_measurements/readme.html">Transferring measurements across meshes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applying u-Unwrap3D to live-cell imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../16_shape_registration/readme.html">Shape registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15_compute_distortion_corrected_uv_measurements/readme.html">Computing distortion-corrected measurements for analysis in uv and topopraphy space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20_surface_flow_analytics/readme.html">Motion and information flow of measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../19_tracking_in_uv/readme.html">Tracking protrusions in 2D uv space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../21_tracking_analytics/readme.html">Analyzing temporally tracked protrusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applications of different surface representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../13_segmenting_surface_protrusions/readme.html">Segmenting surface protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../13_segmenting_surface_protrusions/binary_segment_protrusions.html">Binary protrusion segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13_segmenting_surface_protrusions/instance_segment_protrusions.html">Instance protrusion segmentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../14_volumizing_reference_and_protrusions/readme.html">Decomposing surface into reference and protrusion meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../18_spherical_harmonics/readme.html">Harmonics analysis of surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mapping open 3D surfaces into 2D</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../12_unwrapping_individual_protrusions/readme.html">Unwrapping individual protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../12_unwrapping_individual_protrusions/unwrap_lamellipodia_protrusion.html">Example: Unwrapping a lamellipodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/glossary.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks/issues/new?title=Issue%20on%20page%20%2F03_basic_workflow/Step1_find_reference_surface.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/03_basic_workflow/Step1_find_reference_surface.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Step 1: Find and create a genus-0 reference surface, S_{ref}(x,y,z)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-surface-mesh-s-x-y-z">1. Read in surface mesh, <span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-conformalized-mean-curvature-flow-cmcf-on-s-x-y-z">2. Run conformalized mean curvature flow (cMCF) on <span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-reference-shape-determination-using-discrete-gaussian-curvature">3. Automatic reference shape determination using discrete Gaussian curvature</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-conformal-and-equiareal-distortion-errors-during-cmcf">4. Quantifying conformal and equiareal distortion errors during cMCF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-conformal-and-equiareal-distortion-error-of-s-ref-x-y-z">5. Quantifying the conformal and equiareal distortion error of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-a-genus-0-s-ref-x-y-z-surface-using-shrinkwrapping-and-voxelization">6. Constructing a genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> surface using shrinkwrapping and voxelization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-similarity-between-the-cmcf-and-constructed-genus-0-s-ref-x-y-z">7. Quantifying the similarity between the cMCF and constructed genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-measurements-onto-the-genus-0-s-ref-x-y-z">8. Mapping measurements onto the genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="step-1-find-and-create-a-genus-0-reference-surface-s-ref-x-y-z">
<h1>Step 1: Find and create a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span><a class="headerlink" href="#step-1-find-and-create-a-genus-0-reference-surface-s-ref-x-y-z" title="Link to this heading">#</a></h1>
<p>From the extracted cell surface, <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>, we will find a reference shape using curvature-minimizing flow using a free-form deformation algorithm, <a class="reference external" href="https://arxiv.org/pdf/1203.6819">conformalized mean curvature flow</a> (cMCF).</p>
<p>Conceptually, this involves:</p>
<ol class="arabic">
<li><p>run cMCF on <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> for <span class="math notranslate nohighlight">\(N\)</span> iterations to generate <span class="math notranslate nohighlight">\(N+1\)</span> shapes (including the input)</p></li>
<li><p>applying a selection/stopping criteria to pick the best shape for the desired reference</p>
<ul>
<li><p>Typically, we measure and monitor the mean absolute value <a class="reference external" href="https://www.cs.jhu.edu/~misha/Fall09/4-surfaces.pdf">discrete Gaussian curvature</a> of mesh vertices at each iteration.</p>
<ul class="simple">
<li><p>Discrete Gaussian curvature is a topological property of the shape that is independent of the meshing of the surface and unlike mean curvature also independent of scale.</p></li>
<li><p>Discrete Gaussian curvature of a vertex is defined as the angle deficit between the sum of the triangle angles incident to the vertex from <span class="math notranslate nohighlight">\(360^0\)</span> (or <span class="math notranslate nohighlight">\(2\pi\)</span> radians).</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \text{Discrete Gaussian curvature of a vertex}, K = 2\pi - \sum(\text{incident triangle angles})\]</div>
<ul class="simple">
<li><p>K = 0 if surface is flat</p></li>
<li><p>K &gt; 0 if surface has positive curvature</p></li>
<li><p>K &lt; 0 if surface has negative curvature</p></li>
</ul>
</li>
<li><p>We empirically <span class="math notranslate nohighlight">\(\langle |K| \rangle\)</span> behaves like a ‘shape state’ parameter, whereby its changepoints identify significant changes in the surface mesh corresponding to significant changes in shape.</p></li>
<li><p>We identify changepoints in <span class="math notranslate nohighlight">\(\langle |K| \rangle\)</span> to generate (possibly multiple) candidate reference shapes</p>
<ul class="simple">
<li><p>for analyzing morphological motifs, we take the 1st candidate shape will be ‘closest’ appearance-wise to <span class="math notranslate nohighlight">\(S(x,y,z)\)</span></p></li>
</ul>
</li>
<li><p>There are many alternatives to define a stopping criteria for curvature-minimizing flows which we discuss in the specific chapter on finding reference e.g:</p>
<ul class="simple">
<li><p>rate of change in <span class="math notranslate nohighlight">\(\langle |K|\rangle\)</span> between successive iterations used in the paper</p></li>
<li><p><a class="reference external" href="https://fwilliams.info/point-cloud-utils/sections/shape_metrics/">chamfer distance</a> between input surface and mesh at each iteration</p></li>
</ul>
</li>
</ul>
</li>
<li><p>genus-0 shrinkwrapping, voxelization and remeshing the discovered reference shape to construct its genus-0 surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span>.</p></li>
</ol>
<p><strong>cMCF Warning Note</strong>: cMCF will not work if your mesh is multiple-component, describing multiple independent surfaces. In this example, we will enforce single-component when reading the mesh file, see: <code class="docutils literal notranslate"><span class="pre">unwrap3D.Mesh.meshtools.read_mesh</span></code>. Otherwise, cMCF is intended for watertight meshes, but we have found it is generally robust to imperfect meshes, tolerating it not being watertight and having holes, particularly when additionally using the <a class="reference external" href="https://github.com/nmwsharp/nonmanifold-laplacian">robust Laplacian</a> instead of the standard cotangent Laplacian. However cMCF may terminate earlier than the specified <span class="math notranslate nohighlight">\(N\)</span> iterations.</p>
<p><strong>Shrinkwrapping advice note</strong>: Shrinkwrapping is an essential step for complex surfaces to guarantee large holes, and handles are covered and made genus-0. However, it adds significant compute time. When your chosen reference shape is devoid of large holes and protrusions i.e is convex, such as the example surface here, shrinkwrapping will not add value, and any small holes should be filled by adjusting the voxelization settings.</p>
<section id="read-in-surface-mesh-s-x-y-z">
<h2>1. Read in surface mesh, <span class="math notranslate nohighlight">\(S(x,y,z)\)</span><a class="headerlink" href="#read-in-surface-mesh-s-x-y-z" title="Link to this heading">#</a></h2>
<p>We assume the user has worked through step 0 which generates and saves a cell surface mesh to the folder <code class="docutils literal notranslate"><span class="pre">example_results/bleb_example/step0_cell_segmentation</span></code>. Furthermore, this cell surface has been colored by curvature and molecular intensity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Utility_Functions.file_io</span> <span class="k">as</span> <span class="nn">fio</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Mesh.meshtools</span> <span class="k">as</span> <span class="nn">meshtools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span>
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Preamble: setting up the folders</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># example cell used</span>
<span class="n">imgfolder</span> <span class="o">=</span> <span class="s1">&#39;../../data/img&#39;</span>
<span class="n">imgfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgfolder</span><span class="p">,</span> <span class="s1">&#39;bleb_example.tif&#39;</span><span class="p">)</span>
<span class="n">basefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the filename with extension</span>

<span class="c1"># create the analysis save folder for this step</span>
<span class="n">savefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;example_results&#39;</span><span class="p">,</span> 
                         <span class="n">basefname</span><span class="p">,</span>
                         <span class="s1">&#39;step1_cMCF_reference&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder</span><span class="p">)</span> <span class="c1"># auto generates the specified folder structure if doesn&#39;t currently exist.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Loading results from previous step</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># load the pre-generated cell surface mesh for the cell</span>
<span class="n">cell_surface_folder</span> <span class="o">=</span> <span class="s1">&#39;example_results/</span><span class="si">%s</span><span class="s1">/step0_cell_segmentation&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)</span>
<span class="n">cell_surface_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell_surface_folder</span><span class="p">,</span> 
                                <span class="s1">&#39;curvature_binary_mesh_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">))</span> 
<span class="n">mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">cell_surface_file</span><span class="p">)</span>

<span class="c1"># also load the molecular signal (PI3K) colored cell surface mesh for the cell for added visualization</span>
<span class="n">cell_surface_file_PI3K</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell_surface_folder</span><span class="p">,</span> 
                                <span class="s1">&#39;PI3K_binary_mesh_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">))</span> 
<span class="n">PI3K_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">cell_surface_file_PI3K</span><span class="p">)</span>

<span class="c1"># load the binary from which the cell surface mesh was derived from </span>
<span class="n">cell_binary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell_surface_folder</span><span class="p">,</span>
                                <span class="s1">&#39;bleb_example_binary_seg.tif&#39;</span><span class="p">)</span>
<span class="n">cell_binary</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">cell_binary_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-conformalized-mean-curvature-flow-cmcf-on-s-x-y-z">
<h2>2. Run conformalized mean curvature flow (cMCF) on <span class="math notranslate nohighlight">\(S(x,y,z)\)</span><a class="headerlink" href="#run-conformalized-mean-curvature-flow-cmcf-on-s-x-y-z" title="Link to this heading">#</a></h2>
<p>Conformalized mean curvature flow (cMCF) is a variant of <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_curvature_flow">mean curvature flow</a> proposed by <a class="reference external" href="https://arxiv.org/abs/1203.6819">Kazhdan et al.</a>. The flow iteratively smooth high curvature surface features with the point (effectively 3D sphere) as the convergence limit. This has the property of seeking surfaces of minimial local surface area (also called <a class="reference external" href="https://en.wikipedia.org/wiki/Minimal_surface">minimal surfaces</a>).</p>
<p>cMCF does not change the topology of <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>. However, the minimal area property shrinks higher genus mesh features such as holes and handles, and improves their convexity which means we can much more efficiently apply shrinkwrapping (significantly less iterations) with voxelization to obtain a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> compared to first performing shrinkwrapping on <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> then doing cMCF.</p>
<p><strong>cMCF Note:</strong> By default, we use the cotangent Laplacian for cMCF. If you get less iterations than specified, try re-running with the robust Laplacian proposed by <a class="reference external" href="https://www.cs.cmu.edu/~kmcrane/Projects/NonmanifoldLaplace/NonmanifoldLaplace.pdf">Sharpe et al.</a> by setting the parameter <code class="docutils literal notranslate"><span class="pre">robust_L=True</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run cMCF on the mesh for 50 iterations, delta=5e-4 using the standard cotangent Laplacian</span>
<span class="c1"># delta governs speed of flow, without adjusting the number of iterations, saving computation time. decrease delta for less smoothing, increase for more. </span>
<span class="n">Usteps_MCF_img</span><span class="p">,</span> <span class="n">mesh_F</span><span class="p">,</span> <span class="n">MCF_measures_dict</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">conformalized_mean_curvature_flow</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> 
                                                                                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                                                                    <span class="n">rescale_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># cMCF is solved in normalized coordinates, when True, the output will be rescaled to be in image coordinates.  </span>
                                                                                    <span class="n">delta</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span> 
                                                                                    <span class="n">conformalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># set this flag to run cMCF, else it will run MCF</span>
                                                                                    <span class="n">robust_L</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># if set, runs MCF/cMCF using the robust Laplacian instead of cotangent Laplacian</span>
                                                                                    <span class="n">mollify_factor</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="c1"># this is a parameter used in the robust Laplacian</span>
                                                                                    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">)</span>  <span class="c1"># &#39;scipy&#39;: standard scipy solver, &#39;pardiso&#39; for using Intel&#39;s pardiso solver to solve in parallel. &#39;pariso&#39; is much faster. But you must use &#39;scipy&#39; if you plan to multiprocess over different cells.</span>

<span class="w">    </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Save the output</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># save the vertex positions with face connectivity</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">),</span> 
              <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">Usteps_MCF_img</span><span class="p">,</span> <span class="c1"># rescaled image coordinates, since we ran with rescale_output=True(default)</span>
               <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="n">mesh_F</span><span class="p">})</span> <span class="c1"># face connectivity</span>

<span class="c1"># save the convergence measures. We computed several but found the mean absolute discrete Gaussian curvature (&lt;|K|&gt;) to best serve as a &#39;shape state&#39; parameter</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_convergence_measures_&#39;</span><span class="o">+</span><span class="n">basefname</span> <span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">),</span>
                           <span class="n">MCF_measures_dict</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/50 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 50/50 [01:01&lt;00:00,  1.22s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualizing and saving (optional) of intermediate surfaces at each iteration of the flow</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.plotting</span> <span class="k">as</span> <span class="nn">plotting</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="c1"># cMCF does not change the mesh face topology, the output is thus an array of vertex positions corresponding to each iteration of flow.</span>
<span class="c1"># optionally we can save each iteration to meshes that can be loaded into e.g. meshlab and snapshotted to make a movie</span>
<span class="c1"># to do this uncomment the following lines. </span>

<span class="n">save_MCF_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> <span class="s1">&#39;cMCF_flow_curvature&#39;</span><span class="p">);</span> <span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_MCF_folder</span><span class="p">)</span>

<span class="c1"># iterate over the cMCF iterations.</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[:]:</span>
    
    <span class="c1"># Curvature mesh</span>
    <span class="n">MCF_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> 
                                    <span class="n">faces</span><span class="o">=</span><span class="n">mesh_F</span><span class="p">,</span> 
                                    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">)</span> <span class="c1"># copy the colors of the original</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">MCF_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_MCF_folder</span><span class="p">,</span> <span class="s1">&#39;curvature_iter_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span><span class="p">))</span> <span class="c1"># variable assignment to prevent printing</span>

    <span class="c1"># PI3K mesh</span>
    <span class="n">MCF_mesh_PI3K</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> 
                                        <span class="n">faces</span><span class="o">=</span><span class="n">mesh_F</span><span class="p">,</span> 
                                        <span class="n">vertex_colors</span><span class="o">=</span><span class="n">PI3K_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">)</span> <span class="c1"># copy the colors of the original</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">MCF_mesh_PI3K</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_MCF_folder</span><span class="p">,</span> <span class="s1">&#39;PI3K_iter_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span><span class="p">))</span> <span class="c1"># variable assignment to prevent printing</span>

    
    <span class="c1"># also take a look through matplotlib </span>
    <span class="n">sampling</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># plot every just so its not fully dense in the plot so we don&#39;t see anything!</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;cMCF Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">MCF_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
               <span class="n">MCF_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">MCF_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
               <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/de6458dfba1229553944ffa8a7547a543489e8f49aad68a88b6a10ea8f642c6e.png" src="../_images/de6458dfba1229553944ffa8a7547a543489e8f49aad68a88b6a10ea8f642c6e.png" />
<img alt="../_images/9674ae0d81498cc988668b69d14435020d8ee64e3d3ca31b5c26e3969569044e.png" src="../_images/9674ae0d81498cc988668b69d14435020d8ee64e3d3ca31b5c26e3969569044e.png" />
<img alt="../_images/2ba0f43e8aed256407567b619b0e0cbdafd8f96daa9575cc70c829c225be562c.png" src="../_images/2ba0f43e8aed256407567b619b0e0cbdafd8f96daa9575cc70c829c225be562c.png" />
<img alt="../_images/c83b80c69e2e1e31581328cc84e8ebacaa115d43e8e9e88db9d1c2e39a98edf9.png" src="../_images/c83b80c69e2e1e31581328cc84e8ebacaa115d43e8e9e88db9d1c2e39a98edf9.png" />
<img alt="../_images/a0648f65f056ce57a4602d37c165922e7e3a654747f3f6977576ccc9a2c2468e.png" src="../_images/a0648f65f056ce57a4602d37c165922e7e3a654747f3f6977576ccc9a2c2468e.png" />
<img alt="../_images/2a14284c3c05dd85e5ad62f5744595947d7b2f399692201a210e02a33ca1f331.png" src="../_images/2a14284c3c05dd85e5ad62f5744595947d7b2f399692201a210e02a33ca1f331.png" />
<img alt="../_images/e23e1a76aa06bb3555d628c332544fa44871da58a22820633ed20562c0a0c1d5.png" src="../_images/e23e1a76aa06bb3555d628c332544fa44871da58a22820633ed20562c0a0c1d5.png" />
<img alt="../_images/ca2ec4b0949da587cbeb51de219acfba7797a16c6efa16d7d35f917a84719b94.png" src="../_images/ca2ec4b0949da587cbeb51de219acfba7797a16c6efa16d7d35f917a84719b94.png" />
<img alt="../_images/0e1454a301810357170951b2eff9e71a4e05f7a7822038390c763cae9a2f2ce3.png" src="../_images/0e1454a301810357170951b2eff9e71a4e05f7a7822038390c763cae9a2f2ce3.png" />
<img alt="../_images/a46880a4af038049b2d4cc2d9fb836df95a15c08a6ee8226587686eb61814fe1.png" src="../_images/a46880a4af038049b2d4cc2d9fb836df95a15c08a6ee8226587686eb61814fe1.png" />
<img alt="../_images/fe531ec9e9e7ac4a4b1ebb68cdc684b3aa3fcd1c9893b4687f1e4ed6ecc29028.png" src="../_images/fe531ec9e9e7ac4a4b1ebb68cdc684b3aa3fcd1c9893b4687f1e4ed6ecc29028.png" />
<img alt="../_images/c76de76fa27ccc79f19278444a942d1b9e69fd2996e64b195a515fddc414e7a1.png" src="../_images/c76de76fa27ccc79f19278444a942d1b9e69fd2996e64b195a515fddc414e7a1.png" />
<img alt="../_images/1d577f176ad9245d7a38f4bc38c038e201e6590d7ca39b3f4562027733ebac20.png" src="../_images/1d577f176ad9245d7a38f4bc38c038e201e6590d7ca39b3f4562027733ebac20.png" />
<img alt="../_images/4718be67684375c33e636dc885c9467f56522318b5cba9e52538b1bb38d5784f.png" src="../_images/4718be67684375c33e636dc885c9467f56522318b5cba9e52538b1bb38d5784f.png" />
<img alt="../_images/9c458ba466e1d547697de7200469f1357edd17bb3ea3a421ff4e2969f4dc7189.png" src="../_images/9c458ba466e1d547697de7200469f1357edd17bb3ea3a421ff4e2969f4dc7189.png" />
<img alt="../_images/4cbf04813bfe5391d61d02886112f7287874582bac546f4686c0dfcf34f12288.png" src="../_images/4cbf04813bfe5391d61d02886112f7287874582bac546f4686c0dfcf34f12288.png" />
<img alt="../_images/c77bf2e20810333efb53cc4a5c843a5c1274071a5049569c1a5ea3be6a0ac41a.png" src="../_images/c77bf2e20810333efb53cc4a5c843a5c1274071a5049569c1a5ea3be6a0ac41a.png" />
<img alt="../_images/1ff32af20bcda033834ef1e0e37b128a85e872189551beb4c4a929208e854510.png" src="../_images/1ff32af20bcda033834ef1e0e37b128a85e872189551beb4c4a929208e854510.png" />
<img alt="../_images/f5b78d676b60fa2d7c288ed4ee7866c7f795b579bb027d69634fc86a6e810452.png" src="../_images/f5b78d676b60fa2d7c288ed4ee7866c7f795b579bb027d69634fc86a6e810452.png" />
<img alt="../_images/6108dce17d45529970beb30c53f6e265600ff126594c250acdd2473815d67137.png" src="../_images/6108dce17d45529970beb30c53f6e265600ff126594c250acdd2473815d67137.png" />
<img alt="../_images/63df293aeb00f88e01748ef835430409d0078aff80a07ec9030a2213f17ce84a.png" src="../_images/63df293aeb00f88e01748ef835430409d0078aff80a07ec9030a2213f17ce84a.png" />
<img alt="../_images/48cd245a30d38771ebddc78218e8975f7e45389e7c90d9acc3d9b63e2fafb44d.png" src="../_images/48cd245a30d38771ebddc78218e8975f7e45389e7c90d9acc3d9b63e2fafb44d.png" />
<img alt="../_images/4dda6fa6f178fe302babc12453753a3fa51a3f4eebdfacec915aa4ef77bcd79b.png" src="../_images/4dda6fa6f178fe302babc12453753a3fa51a3f4eebdfacec915aa4ef77bcd79b.png" />
<img alt="../_images/59eb45477bfd0cbb8fa43598e7dff9ecbd54ea771fd3afff136e768da597c672.png" src="../_images/59eb45477bfd0cbb8fa43598e7dff9ecbd54ea771fd3afff136e768da597c672.png" />
<img alt="../_images/b46dbc9e54a399ba0ed5d4a504c3561147a24ec7a3f2e7480236f0f2dc42432f.png" src="../_images/b46dbc9e54a399ba0ed5d4a504c3561147a24ec7a3f2e7480236f0f2dc42432f.png" />
<img alt="../_images/0172f6d5c91ce4c55eefc60874a67eac890c1925793302f89df3ca273b8c0d7d.png" src="../_images/0172f6d5c91ce4c55eefc60874a67eac890c1925793302f89df3ca273b8c0d7d.png" />
<img alt="../_images/3fd7032163895c653d1694036ed146acce782b1e7a95bec08a7efdb121480b3e.png" src="../_images/3fd7032163895c653d1694036ed146acce782b1e7a95bec08a7efdb121480b3e.png" />
<img alt="../_images/4a07f106080a761c4bd0b561c33723e4ded37b66f2e4e21c65ed42505b488bcc.png" src="../_images/4a07f106080a761c4bd0b561c33723e4ded37b66f2e4e21c65ed42505b488bcc.png" />
<img alt="../_images/a92d7f74c5c032bcdab8b3515ad24976165b8071e97c02382df007ae295a540e.png" src="../_images/a92d7f74c5c032bcdab8b3515ad24976165b8071e97c02382df007ae295a540e.png" />
<img alt="../_images/f31571c195965c9d89595dc86f842eca5304f20e56e9ebe4069354a760dd873b.png" src="../_images/f31571c195965c9d89595dc86f842eca5304f20e56e9ebe4069354a760dd873b.png" />
<img alt="../_images/17e77f580953b04bd2b92d154baaa38304395c0115aa3e176f1e2c7ac9ccc8cd.png" src="../_images/17e77f580953b04bd2b92d154baaa38304395c0115aa3e176f1e2c7ac9ccc8cd.png" />
<img alt="../_images/1c8c1f812681cf86996c1f3b3fcddde64252fc304953f6ba16d4653e9a8b7191.png" src="../_images/1c8c1f812681cf86996c1f3b3fcddde64252fc304953f6ba16d4653e9a8b7191.png" />
<img alt="../_images/8f1b927827fdd4576b5b0627ca2c652bee1fd5b30a55c3079a01f1249d3a2061.png" src="../_images/8f1b927827fdd4576b5b0627ca2c652bee1fd5b30a55c3079a01f1249d3a2061.png" />
<img alt="../_images/236c20abe0d6925850501fc2c59fa15d8ce99dc6cc919f9b7ad6b3651cebcf95.png" src="../_images/236c20abe0d6925850501fc2c59fa15d8ce99dc6cc919f9b7ad6b3651cebcf95.png" />
<img alt="../_images/43eac2cde068af63456fa92ef01ee4014373477bd5a6fd4ea621b2a25bf3e677.png" src="../_images/43eac2cde068af63456fa92ef01ee4014373477bd5a6fd4ea621b2a25bf3e677.png" />
<img alt="../_images/771a743331ed3abe9c335fb26fe87fcdf5a90bcaa4a5c56ee45289bb7bea44fd.png" src="../_images/771a743331ed3abe9c335fb26fe87fcdf5a90bcaa4a5c56ee45289bb7bea44fd.png" />
<img alt="../_images/0b2d57b9983d77c3bdf4b67690b594e43f3546ce9c07d19d8ce94e42fcce6ec1.png" src="../_images/0b2d57b9983d77c3bdf4b67690b594e43f3546ce9c07d19d8ce94e42fcce6ec1.png" />
<img alt="../_images/dee2a8012aabd49bf25df177f2f48a27de241fe5f44d27a92b25219121071023.png" src="../_images/dee2a8012aabd49bf25df177f2f48a27de241fe5f44d27a92b25219121071023.png" />
<img alt="../_images/65cffdedfd42f45548d7e57f53d62687a06d3777e39fc810dc52021dd75d7e34.png" src="../_images/65cffdedfd42f45548d7e57f53d62687a06d3777e39fc810dc52021dd75d7e34.png" />
<img alt="../_images/f5892e34966d069f635ac1d1cf21882f3588fa766198a8e0252c5b083134fdcf.png" src="../_images/f5892e34966d069f635ac1d1cf21882f3588fa766198a8e0252c5b083134fdcf.png" />
<img alt="../_images/fdf100e07d468c4f2ca9cc82483d3ea4603ff3264b30405fd12745b49266c6d3.png" src="../_images/fdf100e07d468c4f2ca9cc82483d3ea4603ff3264b30405fd12745b49266c6d3.png" />
<img alt="../_images/7e8aad90ebdf2b948217033160c8c00d7ea7ac6f98e189d0a266cf638120336c.png" src="../_images/7e8aad90ebdf2b948217033160c8c00d7ea7ac6f98e189d0a266cf638120336c.png" />
<img alt="../_images/11d2b0d32ddfa127a33bbdd2316bef75d3acecabcde905c553cdad7e1e53b4d7.png" src="../_images/11d2b0d32ddfa127a33bbdd2316bef75d3acecabcde905c553cdad7e1e53b4d7.png" />
<img alt="../_images/f198802e0827473a88ac05582a8829eba0b2ae10dcf0b666b83adadebab9a78e.png" src="../_images/f198802e0827473a88ac05582a8829eba0b2ae10dcf0b666b83adadebab9a78e.png" />
<img alt="../_images/c6f8bfed3d5a17dc705a5d8c6aad0b439e2284b103e9062fd06fcfc0744538e2.png" src="../_images/c6f8bfed3d5a17dc705a5d8c6aad0b439e2284b103e9062fd06fcfc0744538e2.png" />
<img alt="../_images/90c3f0ff510956ae1b07cbf6567412b65dc6089e80646209e0e8f448b513fc3c.png" src="../_images/90c3f0ff510956ae1b07cbf6567412b65dc6089e80646209e0e8f448b513fc3c.png" />
<img alt="../_images/0d7b911b935a61e48df22664e35c65b517f1f1280b2dbf222ee2f80659f8a716.png" src="../_images/0d7b911b935a61e48df22664e35c65b517f1f1280b2dbf222ee2f80659f8a716.png" />
<img alt="../_images/422440fbff4022f49e1e9481a65b45fbc8f3d4c264603cd08a0b4fe5b555697d.png" src="../_images/422440fbff4022f49e1e9481a65b45fbc8f3d4c264603cd08a0b4fe5b555697d.png" />
<img alt="../_images/0ed825bdcdbe38517965d484e3293b242f821b974ffdbbe2189242c0dbeead95.png" src="../_images/0ed825bdcdbe38517965d484e3293b242f821b974ffdbbe2189242c0dbeead95.png" />
<img alt="../_images/854104c062482adf10981831b485a81d8a6079eb586b86907dde7cea58ab9aa7.png" src="../_images/854104c062482adf10981831b485a81d8a6079eb586b86907dde7cea58ab9aa7.png" />
<img alt="../_images/33ce0fc4479e05717693a14bc4253a1e07f1a72e208b299a75d3fbf587ec0c78.png" src="../_images/33ce0fc4479e05717693a14bc4253a1e07f1a72e208b299a75d3fbf587ec0c78.png" />
</div>
</div>
</section>
<section id="automatic-reference-shape-determination-using-discrete-gaussian-curvature">
<h2>3. Automatic reference shape determination using discrete Gaussian curvature<a class="headerlink" href="#automatic-reference-shape-determination-using-discrete-gaussian-curvature" title="Link to this heading">#</a></h2>
<p>We would like to select a shape which is closest to the input <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> with surface protrusions smoothed out, in this case the blebs. We do this by finding potential changepoints in the curve of the mean absolute discrete Gaussian curvature. The changepoint algorithm we use is to detect peaks after subtracting the curve from its baseline inferred by moving window average. This may generate one or multiple shape candidates. For the closest fit, we select the first candidate.</p>
<p><strong>Comment:</strong>
In the paper, we initially described monitoring the rate of change in mean absolute vertex discrete Gaussian curvature to determine the iteration number of cMCF. The cutoff however is difficult to set for different protrusion types, the rate of change behaves weirdly (does not necessarily decay) when surface mesh is not watertight and manifolder, and does not give the closest surface to <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> without surface protrusions. We used this initially because we had not developed shrinkwrapping and needed to run more iterations to find a shape that could be made genus-0 with voxelization only.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the mean absolute Gaussian curvature at vertices at each iteration of the cMCF</span>
<span class="n">gauss_curve_MCF</span> <span class="o">=</span> <span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;gauss_curvature_iter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># find changepoints in the curve, generally default is fine.</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">find_all_curvature_cutoff_index</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">,</span> 
                                                 <span class="n">avg_fnc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="c1"># use moving means </span>
                                                 <span class="n">absval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># absolute value after subtracting baseline </span>
                                                 <span class="n">winsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="c1"># window size for moving means, larger tends to slightly bias the found iteration number to later </span>
                                                 <span class="n">min_peak_height</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="c1"># minimum peak height</span>
                                                 <span class="n">min_peak_distance</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># minimal distance between detected peaks. </span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;possible iteration numbers for reference shape:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>

<span class="c1"># # Alternative, rate-of-change: (used in the paper for validation, now deprecated, not recommended)</span>
<span class="c1"># threshold_cMCF = 5e-7</span>
<span class="c1"># # determine the cut off iteration number such that the change between the previous iteration drops below 5e-7</span>
<span class="c1"># ind = meshtools.find_curvature_cutoff_index( gauss_curve_MCF, </span>
<span class="c1">#                                               thresh=threshold_cMCF,  # cutoff on the rate of change.</span>
<span class="c1">#                                               absval=True) </span>

<span class="c1"># plot the found inds onto the curve</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">plot the evolution of the curve and mark all found iteration numbers</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> 
          <span class="n">gauss_curve_MCF</span><span class="p">,</span> <span class="s1">&#39;.-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">),</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gauss_curve_MCF</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration Number&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. Gaussian Curvature&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">)),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">plot the vertices of the shape at all found iteration numbers </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">n_inds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span> <span class="n">n_inds</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1"># generate subplots</span>
<span class="k">for</span> <span class="n">ind_ii</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="n">ind_ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;cMCF Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
               <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
               <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;cMCF&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
               <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">][::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
               <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># choose the first as the closest shape</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># add the determined index to the MCF_measures_dict and resave. </span>
<span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;cMCF_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
<span class="n">MCF_measures_dict</span><span class="p">[</span><span class="s1">&#39;cMCF_all_inds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_convergence_measures_&#39;</span><span class="o">+</span><span class="n">basefname</span> <span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">),</span>
                           <span class="n">MCF_measures_dict</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>possible iteration numbers for reference shape:
[4]
</pre></div>
</div>
<img alt="../_images/eed5d154ff58c1916f57abd3543f5f65d6f690274c4287fe26bfcdbb5f89fba1.png" src="../_images/eed5d154ff58c1916f57abd3543f5f65d6f690274c4287fe26bfcdbb5f89fba1.png" />
<img alt="../_images/7b5f927afc086222ceaa2eb1fd0cc8470ba4b93dd87e567f52a5ae07780eccf0.png" src="../_images/7b5f927afc086222ceaa2eb1fd0cc8470ba4b93dd87e567f52a5ae07780eccf0.png" />
</div>
</div>
</section>
<section id="quantifying-conformal-and-equiareal-distortion-errors-during-cmcf">
<h2>4. Quantifying conformal and equiareal distortion errors during cMCF<a class="headerlink" href="#quantifying-conformal-and-equiareal-distortion-errors-during-cmcf" title="Link to this heading">#</a></h2>
<p>We can measure the conformal and equiareal distortion error at each cMCF iteration relative to the initial surface <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>.</p>
<p><strong>Note:</strong> This is slow, and we don’t do this normally. It is here for completeness, demonstrating how to compute these measures with u-Unwrap3D if we wish and to show that these flows distorts local surface area, and to a less extent the aspect ratio of triangles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conformal_error_flow</span> <span class="o">=</span> <span class="p">[</span><span class="n">meshtools</span><span class="o">.</span><span class="n">quasi_conformal_error</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">steps</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span> <span class="k">for</span> <span class="n">steps</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
<span class="n">area_distortion_error_flow</span> <span class="o">=</span> <span class="p">[</span><span class="n">meshtools</span><span class="o">.</span><span class="n">area_distortion_measure</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">steps</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span> <span class="k">for</span> <span class="n">steps</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>

<span class="c1"># figure out how to save out these information.</span>
<span class="n">conformal_error_flow_arrays</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">conformal_error_flow</span><span class="p">])</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conformal_error_flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
<span class="n">area_distortion_error_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area_distortion_error_flow</span><span class="p">)</span> 

<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;MCF_conformal_area_errors.mat&#39;</span><span class="p">),</span> 
                          <span class="p">{</span><span class="s1">&#39;conformal_Jac_eigvals&#39;</span><span class="p">:</span> <span class="n">conformal_error_flow_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                          <span class="s1">&#39;conformal_stretch_factors&#39;</span><span class="p">:</span> <span class="n">conformal_error_flow_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># this is the per face conformal error. </span>
                          <span class="s1">&#39;mean_conformal_stretch_factors&#39;</span><span class="p">:</span> <span class="n">conformal_error_flow_arrays</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1"># this is the mean conformal error at each iteration</span>
                          <span class="s1">&#39;conformal_tri_area_pairs&#39;</span><span class="p">:</span> <span class="n">conformal_error_flow_arrays</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
                          <span class="s1">&#39;conformal_area_distortion_factor&#39;</span><span class="p">:</span> <span class="n">area_distortion_error_flow</span><span class="p">})</span> <span class="c1"># this is the per face equiareal error. </span>
    
</pre></div>
</div>
</div>
</div>
<p>Plot the mean conformal (left axis) and equiareal distortion (right axis) errors as a function of the cMCF iteration number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_conformal_error_curve</span> <span class="o">=</span> <span class="n">conformal_error_flow_arrays</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">mean_area_errors_curve</span> <span class="o">=</span> <span class="n">area_distortion_error_flow</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># plot the errors as a function of iteration number </span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration Number&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Conformal error&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_conformal_error_curve</span><span class="p">)),</span> <span class="n">mean_conformal_error_curve</span><span class="p">,</span> <span class="s1">&#39;ko-&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Final area / initial area&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>  <span class="c1"># we already handled the x-label with ax1</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_area_errors_curve</span><span class="p">)),</span> <span class="mf">1.</span><span class="o">/</span><span class="n">mean_area_errors_curve</span><span class="p">,</span> <span class="s1">&#39;ro-&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>  
                       <span class="s1">&#39;mean_MCF_errors_iterations_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cd9c1ca33bef86910a6abe7ee6455c620285e847a9d6e170fdf90ff01c2487cf.png" src="../_images/cd9c1ca33bef86910a6abe7ee6455c620285e847a9d6e170fdf90ff01c2487cf.png" />
</div>
</div>
</section>
<section id="quantifying-the-conformal-and-equiareal-distortion-error-of-s-ref-x-y-z">
<h2>5. Quantifying the conformal and equiareal distortion error of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span><a class="headerlink" href="#quantifying-the-conformal-and-equiareal-distortion-error-of-s-ref-x-y-z" title="Link to this heading">#</a></h2>
<p>In practice, we do not need to compute the errors for every cMCF iteration. We are mostly interested in the error for the chosen shape, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span>. The code below demonstrates the computation, then colormapping of the values to display on the surface mesh of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.colors</span> <span class="k">as</span> <span class="nn">vol_colors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> 

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">conformal error</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">conformal_error</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">quasi_conformal_error</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                                                  <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">],</span> 
                                                  <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
<span class="c1"># color mapping S(x,y,z) using a 1-1.5 scale in jet.</span>
<span class="n">conformal_error_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">conformal_error</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="n">img_binary_conformal_colors</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">faces</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
                                                  <span class="n">face_colors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">conformal_error_colors</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]))</span> <span class="c1"># note we set the face_colors </span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_conformal_colors</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                                <span class="s1">&#39;curvature_cMCF_conformal_error.obj&#39;</span><span class="p">))</span>
<span class="c1"># also color the cMCF shape. </span>
<span class="n">img_binary_conformal_colors</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_conformal_colors</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                           <span class="s1">&#39;curvature_cMCF_conformal_error_Sref.obj&#39;</span><span class="p">))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">equiareal distortion error</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">area_distortion_error</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">area_distortion_measure</span><span class="p">(</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># original</span>
                                                          <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">],</span> <span class="c1"># cMCF</span>
                                                          <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>

<span class="c1"># color mapping S(x,y,z) the -log(area fraction) using a -3 to 3 scale in reverse coolwarm so that negative means the original surface has been compressed whilst a positive value means the original surface has been expanded.</span>
<span class="n">area_distortion_error_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area_distortion_error</span><span class="p">),</span> 
                                                      <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm_r</span><span class="p">,</span> 
                                                      <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">img_binary_area_colors</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">faces</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
                                              <span class="n">face_colors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">area_distortion_error_colors</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]))</span> 
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_area_colors</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                           <span class="s1">&#39;curvature_MCF_paper_area_error.obj&#39;</span><span class="p">))</span>

<span class="c1"># also color the cMCF shape. </span>
<span class="n">img_binary_area_colors</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_area_colors</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                           <span class="s1">&#39;curvature_MCF_paper_area_error_Sref.obj&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="constructing-a-genus-0-s-ref-x-y-z-surface-using-shrinkwrapping-and-voxelization">
<h2>6. Constructing a genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> surface using shrinkwrapping and voxelization<a class="headerlink" href="#constructing-a-genus-0-s-ref-x-y-z-surface-using-shrinkwrapping-and-voxelization" title="Link to this heading">#</a></h2>
<p>If the <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> from cMCF is not genus-0, we cannot map it to a sphere. Practically, area-distortion relaxation will fail due to numerical instability if any protrusive features of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> is sharp (high curvature, point-like) or its shape has very thin ‘necks’ even if it genus-0.</p>
<p>Shrinkwrapping guarantees the construction of a genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> surface, whilst voxelization allows the use of morphological operations, particularly dilation to remove sharp points and thin necks that would later prevent obtaining an equiareal spherical parameterization after step 4 of the u-Unwrap3D standard workflow.</p>
<p><strong>Shrinkwrapping</strong></p>
<p>As the name suggests, we shrinkwrap an initial genus-0 surface (i.e. without cutting, tearing etc) to obtain a genus-0 equivalent of the target shape. This is an iterative procedure involving the following steps:</p>
<ol class="arabic simple">
<li><p>Compute a good initial genus-0 surface using <a class="reference external" href="https://doc.cgal.org/latest/Alpha_wrap_3/index.html">alphawrap</a> and interval bisection, <code class="docutils literal notranslate"><span class="pre">see</span> <span class="pre">unwrap3D.Mesh.meshtools.alphawrap_genus0</span></code>.</p></li>
<li><p>Compute the <a class="reference external" href="https://en.wikipedia.org/wiki/Gradient_vector_flow">gradient vector field</a> of input surface and deform the initial genus-0 surface using active contours to refine to input surface for a number of epochs.</p></li>
<li><p>Detect local areas where shrinkwrapping has yet to converge because flow is hindered by large concavities and triangle quality has become poor c.f. <a class="reference external" href="https://en.wikipedia.org/wiki/Gradient_vector_flow">gradient vector flow convergence</a>. Remove triangles in these regions, stitch the gap and remesh whilst remaining genus-0. Repeat 2 above to refine again. Repeat 3 and 2 as needed until convergence. For challenging morphologies with long and narrow concavities, this might be 4, 5 times.</p></li>
</ol>
<p><strong>N.B:</strong> Whilst the shrinkwrapping approach we developed in u-Unwrap3D is accurate, it is also slow because it runs on an image grid, therefore we wouldn’t perform if the cMCF <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> was already genus-0 or has only small holes and handles that can be readily fixed by voxelization and morphological operations. Similarly if the initial genus-0 surface is already sufficient (true for largely-convex shapes), skip steps 2,3 in the shrinkwrapping. You can also significantly boost speed, if you downsize the mesh so that vertices correspond to a smaller image volume.</p>
<p><strong>Voxelization</strong></p>
<p>Voxelizing the mesh i.e. convert it to a binary volume image enables us to use binary morphological operations to easily close small holes and handles, fill in internal volume and dilate to remove sharp protrusive features and widen narrow necks. Voxelization in u-Unwrap3D works by:</p>
<ol class="arabic simple">
<li><p>upsampling the input mesh to have minimum edge length &lt; 2 voxels and rasterization onto a image grid.</p></li>
<li><p>dilating the binary by <span class="math notranslate nohighlight">\(k_{\text{dilate}}\)</span> voxels,</p></li>
<li><p>binary infill holes</p></li>
<li><p>eroding by <span class="math notranslate nohighlight">\(k_{\text{erode}}\)</span> voxels.</p></li>
</ol>
<p>The steps above are made available in a single function, <code class="docutils literal notranslate"><span class="pre">unwrap3D.Mesh.meshtools.voxelize_image_mesh_pts</span></code>.</p>
<p>After these operations, we re-extract the surface mesh of the binary volume to get a genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> suitable for spherical parameterization.</p>
<p><strong>NOTE</strong>: In this example, both shrinkwrapping and voxelization is extraneous steps. The original mesh is already genus-0, isotropically meshed and its cMCF <span class="math notranslate nohighlight">\(S_\text{ref}\)</span> is effectively convex, devoid of any concavities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first explicitly make a mesh of the intermediate S_ref(x,y,z) obtained direct from cMCF.  </span>
<span class="n">cMCF_Sref</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">Usteps_MCF_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ind</span><span class="p">],</span>  
                                    <span class="n">faces</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
                                    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">)</span>

<span class="n">save_smooth_mesh_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                     <span class="s1">&#39;unwrap_cMCF_smooth_mesh.obj&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">save_smooth_mesh_file</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Part 1:</span>

<span class="sd">Shrinkwrapping of mesh (steps 1 and 2 only, 3 is commented out and included only for completeness)</span>
<span class="sd">    - shrinkwrapping steps 1 and 2 are provided in one single function</span>
<span class="sd">    - shrinkwrapping step 3 is dependent on the input and is carried out in a loop. [ we currently have not tested automatic criteria to determine when it is necessary]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># perform shrinkwrap 1 and 2 in one function call (most common usage for cMCF Sref)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># the number of epochs = total_shrinkwrap_iters / remesh_iters. total_shrinkwrap_iters = 200  is good for most shapes, For simple shapes, reduce this number by multiple of remesh_iters. </span>
<span class="c1"># remesh_iters = 10 is good for most, does not require changing.</span>
<span class="c1"># make_manifold = True manipulates the input mesh to be watertight first. It results in a less tight shrinkwrap</span>
<span class="c1"># decay_rate adjusts the learning rate each epoch by this fraction [the algorithm cycles learning rate to avoid local minima] </span>
<span class="c1"># min_lr ensures learing rate does not decrease beyond this. </span>

<span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># we can lower number when the shape is simple, as here, or let it be higher to see if we can get better wrap than initial</span>
<span class="n">decay_rate</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">min_lr</span> <span class="o">=</span> <span class="mf">0.24</span> <span class="c1"># for decay_rate 0.5, this would mean lowest is 0.25.</span>

<span class="n">n_punchout_refinements</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Set this &gt;0 to run shrinkwrapping step 3 - step 2 loop n times for complex shapes with nasty concavities. Not needed here.</span>

<span class="c1"># one round is largely sufficient for most cMCF Sref shapes as by definition they should have concavities largely removed. </span>
<span class="n">mesh_shrinkwrap</span><span class="p">,</span> <span class="n">mesh_watertight_in</span><span class="p">,</span> <span class="n">mesh_genus0</span><span class="p">,</span> <span class="n">iter_stats</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">shrinkwrap_genus0_basic</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="p">,</span> 
                                                                                                <span class="n">use_GVF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                                                <span class="n">GVF_mu</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                                                                                                <span class="n">GVF_iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                                                                                <span class="n">voxelize_padsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                                                                                <span class="n">voxelize_dilate_ksize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># make dilate_ksize &gt; erode_ksize if your mesh doesn&#39;t form a complete volume or there is quite a bit of holes.</span>
                                                                                                <span class="n">voxelize_erode_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  
                                                                                                <span class="n">extra_pad</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                                                <span class="n">genus0_alpha_frac</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span> <span class="c1"># default</span>
                                                                                                <span class="n">genus0_alpha_auto</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                                                                <span class="n">genus0_tol</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> 
                                                                                                <span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="n">total_shrinkwrap_iters</span><span class="p">,</span>
                                                                                                <span class="n">decay_rate</span> <span class="o">=</span> <span class="n">decay_rate</span><span class="p">,</span>  
                                                                                                <span class="n">remesh_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                                                <span class="n">conformalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># use active contours - recommended </span>
                                                                                                <span class="n">min_size</span><span class="o">=</span><span class="mf">40e3</span><span class="p">,</span> <span class="c1"># minimum mesh vertices, increase might better cover smaller cavities but greatly increase computational time!</span>
                                                                                                <span class="n">upsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                <span class="n">min_lr</span><span class="o">=</span><span class="n">min_lr</span><span class="p">,</span> <span class="c1"># minimum step_size dropping from 1.</span>
                                                                                                <span class="n">make_manifold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># run this. </span>
                                                                                                <span class="n">watertight_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                                                <span class="n">deltaL</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
                                                                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># controls stiffness</span>
                                                                                                <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="c1"># controls torsion</span>
                                                                                                <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">,</span>
                                                                                                <span class="n">curvature_weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                                                                <span class="n">debugviz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># leave on if you want to see the state of the mesh, otherwise off. </span>
        
<span class="c1"># save out the output for visualization and checking </span>
<span class="n">tmp</span><span class="o">=</span><span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                        <span class="s1">&#39;shrinkwrap_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span> <span class="c1"># this should be same as the last iteration mesh.</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                               <span class="s1">&#39;input_Sref_to_shrinkwrapping_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_genus0</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                      <span class="s1">&#39;initial_genus0_shrinkwrap_Sref_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                              <span class="s1">&#39;shrinkwrap_final-iter_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>


<span class="c1"># setup save variables ready for step 3 processing. [those stats will append to these]</span>
<span class="n">chamfer_dists</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">all_meshes_iter_genus0</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># this completes the euler number for each iteration - you can check this is 2.</span>
<span class="n">all_meshes_iter</span> <span class="o">=</span> <span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
<span class="c1"># step 3 shrinkwrap code, executed only if n_punchout_refinements&gt;0</span>
<span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># run this a few times. </span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_punchout_refinements</span><span class="p">):</span> <span class="c1"># use more iterations until happy </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. detect nonconverged. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">remove_nonshrinkwrap_triangles</span><span class="p">(</span><span class="n">mesh_wrap</span><span class="p">,</span>
                                                        <span class="n">mesh</span><span class="p">,</span>
                                                        <span class="n">q_thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                        <span class="n">max_dist_cutoff</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="c1"># this controls the fidelity... </span>
                                                        <span class="n">sigma_dist_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                                        <span class="n">sigma_area_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># this ? </span>
                                                        <span class="n">nearest_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">dilate_voxels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># cut more away ? </span>
                                                        <span class="n">erode_voxels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">minsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    2. re-prop surface. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh_shrinkwrap</span><span class="p">,</span> <span class="n">mesh_watertight_in</span><span class="p">,</span> <span class="n">mesh_genus0</span><span class="p">,</span> <span class="n">iter_stats</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">attract_surface_mesh</span><span class="p">(</span><span class="n">mesh_in</span><span class="o">=</span><span class="n">mesh_wrap</span><span class="p">,</span>
                                                                                                        <span class="n">mesh_ref</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> 
                                                                                                        <span class="n">use_GVF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                                                        <span class="n">GVF_mu</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># this large, introduces noise </span>
                                                                                                        <span class="n">GVF_iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                                                                    <span class="n">voxelize_padsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1"># this is just leave enough padding space </span>
                                                                                                    <span class="n">voxelize_dilate_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                                                                    <span class="n">voxelize_erode_ksize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">## was this cos of 3? </span>
                                                                                                    <span class="n">extra_pad</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                                                    <span class="n">tightest_genus0_initial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_alpha_frac</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_alpha_auto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_offset</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                                                                                    <span class="n">genus0_tol</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
                                                                                                    <span class="n">total_shrinkwrap_iters</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="c1"># master number of iterations.</span>
                                                                                                    <span class="n">decay_rate</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="c1"># no decay. </span>
                                                                                                    <span class="n">remesh_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                                                    <span class="n">conformalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># use active contours</span>
                                                                                                    <span class="n">min_size</span><span class="o">=</span><span class="mi">80000</span><span class="p">,</span> <span class="c1"># minimum mesh vertices</span>
                                                                                                    <span class="n">upsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                    <span class="n">min_lr</span><span class="o">=</span><span class="n">min_lr</span><span class="p">,</span> <span class="c1"># minimum step_size dropping from 1.</span>
                                                                                                    <span class="n">make_manifold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># ah.. its prob this too. </span>
                                                                                                    <span class="n">watertight_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                                                    <span class="n">deltaL</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
                                                                                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># more stiff here and we can break through? </span>
                                                                                                    <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="c1"># what if we reduce the bending? </span>
                                                                                                    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;pardiso&#39;</span><span class="p">,</span>
                                                                                                    <span class="n">curvature_weighting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                                                                    <span class="n">debugviz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">all_meshes_iter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">all_meshes_iter_genus0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">chamfer_dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    insert save if you want to check </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># here, i&#39;m going to rewrite the previous final iteration shrinkwrap. checking how good this is, is a good general indicator if we need more refinement iterations i.e. increase the number of loops</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                              <span class="s1">&#39;shrinkwrap_final-iter_</span><span class="si">%s</span><span class="s1">_cMCF-Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>
    
    <span class="n">mesh_wrap</span> <span class="o">=</span> <span class="n">mesh_shrinkwrap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="c1"># flatten all of it </span>
<span class="k">if</span> <span class="n">n_punchout_refinements</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">all_meshes_iter_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">all_meshes_iter_item</span> <span class="ow">in</span> <span class="n">all_meshes_iter</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_meshes_iter_item</span><span class="p">]</span>
    <span class="n">all_meshes_iter_genus0_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">all_meshes_iter_item</span> <span class="ow">in</span> <span class="n">all_meshes_iter_genus0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_meshes_iter_item</span><span class="p">]</span>
    <span class="n">all_chamfer_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">chamfer_dists</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">all_meshes_iter_flat</span> <span class="o">=</span> <span class="n">all_meshes_iter</span>
    <span class="n">all_meshes_iter_genus0_flat</span> <span class="o">=</span> <span class="n">all_meshes_iter_genus0</span>
    <span class="n">all_chamfer_dists</span> <span class="o">=</span> <span class="n">chamfer_dists</span>


<span class="c1"># plot the chamfer distance to input surface to guide whats the best mesh to use.</span>
<span class="c1"># save this out </span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_chamfer_dists</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">all_meshes_iter_genus0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch Number&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Liberation Sans&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Chamfer distance&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;Liberation Sans&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                            <span class="s1">&#39;Chamfer-distance_shrinkwrap_to_input_per_iteration.pdf&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># we take the mesh with lowest chamfer distance to the input surface as the genus-0 $S_\text{ref}$</span>
<span class="n">final_mesh</span> <span class="o">=</span> <span class="n">all_meshes_iter_flat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">all_chamfer_dists</span><span class="p">)]</span>

<span class="c1"># we isotropically remesh this output to ensure good triangle quality [optional if running voxelization after]</span>
<span class="n">final_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">incremental_isotropic_remesh</span><span class="p">(</span><span class="n">final_mesh</span><span class="p">)</span>

<span class="c1"># save the final mesh</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">final_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                     <span class="s1">&#39;final_shrinkwrap_</span><span class="si">%s</span><span class="s1">_cMCF_Sref.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>

<span class="c1"># we can save all the meshes </span>
<span class="n">save_shrinkwrap_meshes_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                             <span class="s1">&#39;shrinkwrap_meshes&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_shrinkwrap_meshes_folder</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ttt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_meshes_iter_flat</span><span class="p">)):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">all_meshes_iter_flat</span><span class="p">[</span><span class="n">ttt</span><span class="p">]</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_shrinkwrap_meshes_folder</span><span class="p">,</span> 
                                                        <span class="s1">&#39;shrinkwrap_iter_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ttt</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initial: 2
initial_watertight: 2
</pre></div>
</div>
<img alt="../_images/ef44f395356d1639e8f141f1f93f9c9ddf38885e700df2c109ed19cb95331d58.png" src="../_images/ef44f395356d1639e8f141f1f93f9c9ddf38885e700df2c109ed19cb95331d58.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initiating a genus-0 mesh automatically with interval:  [3.004936615559782, 3.0055246926182777]
</pre></div>
</div>
<img alt="../_images/fccb240220164f923379e07c1e75e930945328f6ae63e9d00c8279bbba31860f.png" src="../_images/fccb240220164f923379e07c1e75e930945328f6ae63e9d00c8279bbba31860f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GVF iter: 15/15(82482, 3)
</pre></div>
</div>
<img alt="../_images/c3d68d7041ed86d3703784496d4d14e37f042c4ab1263f16b4fe40736d598c7e.png" src="../_images/c3d68d7041ed86d3703784496d4d14e37f042c4ab1263f16b4fe40736d598c7e.png" />
<img alt="../_images/601bc4ff957b855880976ace0712828d3a061d061759b9e0bc1f8e71ecdad969.png" src="../_images/601bc4ff957b855880976ace0712828d3a061d061759b9e0bc1f8e71ecdad969.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
0 4.154158643545541 changing lr:  0.75
0 4.154158643545541
1
==========================
2
--------------------------
1 3.9342746914386995
2
==========================
2
--------------------------
2 3.928994295314892
3
==========================
2
--------------------------
3 3.928257314914751
4
==========================
2
--------------------------
4 3.930037788270435 changing lr:  0.5625
4 3.930037788270435
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
findfont: Font family &#39;Liberation Sans&#39; not found.
</pre></div>
</div>
<img alt="../_images/84670c32afc262a813cc88bda2ebbda5f21a89b59ead025d7280dd9c617be30a.png" src="../_images/84670c32afc262a813cc88bda2ebbda5f21a89b59ead025d7280dd9c617be30a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s first rename the final mesh from the shrinkwrapping </span>
<span class="n">shrinkwrap_mesh</span> <span class="o">=</span> <span class="n">final_mesh</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Voxelization of mesh </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># vol_shape allows us when available to use the volume grid size of the original image. -&gt; the advantage is that no postcorrection is required to maintain image coordinates.</span>
<span class="c1"># If not available the maximum extent of the vertices are used to determine a bounding box which is then padded</span>
<span class="n">smooth_img_binary</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">voxelize_image_mesh_pts</span><span class="p">(</span><span class="n">shrinkwrap_mesh</span><span class="p">,</span> <span class="c1"># might be best here to use barycenter </span>
                                                      <span class="n">pad</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                                      <span class="n">dilate_ksize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># this is the size of the ball kernel to plug holes and handles. </span>
                                                      <span class="n">erode_ksize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># this undoes the dilation to keep the remesh close to the original surface.</span>
                                                      <span class="n">vol_shape</span><span class="o">=</span><span class="n">cell_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># If you know your image shape, specify the vol_shape for better speed, otherwise use None The ::-1, is because S(x,y,z) was extracted from a transposed version of the cell binary</span>
<span class="c1"># HINT: if you have sharp protrusive features in Sref, set erode_ksize at least 2 less than dilate_ksize to help later area-distortion relaxation.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Re-extraction of surface mesh to obtain the final genus-0 $S_{\text{ref}(x,y,z)} for spherical parameterization </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">cMCF_Sref_remesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">marching_cubes_mesh_binary</span><span class="p">(</span><span class="n">smooth_img_binary</span><span class="p">,</span> 
                                                            <span class="n">presmooth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
                                                            <span class="n">contourlevel</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> 
                                                            <span class="n">remesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                            <span class="n">remesh_method</span><span class="o">=</span><span class="s1">&#39;CGAL&#39;</span><span class="p">,</span> 
                                                            <span class="n">remesh_samples</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="c1"># lower downsampling will give a coarser mesh, which is easier to get equiareal spherical parameterization but may lose accuracy in representing high-curvature protrusive features (if present).</span>
                                                            <span class="n">predecimate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># only essential if remesh_method=&#39;pyacvd </span>
                                                            <span class="n">min_mesh_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>  

<span class="n">save_smooth_remesh_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                     <span class="s1">&#39;unwrap_cMCF_Sref_mesh.obj&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">save_smooth_remesh_file</span><span class="p">)</span>


<span class="c1"># check this remesh gives a genus-0 mesh</span>
<span class="n">mesh_property</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">measure_props_trimesh</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="p">,</span> <span class="n">main_component</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">mesh_property</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;convex&#39;: False, &#39;volume&#39;: True, &#39;watertight&#39;: True, &#39;orientability&#39;: True, &#39;euler_number&#39;: 2, &#39;genus&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
</section>
<section id="quantifying-the-similarity-between-the-cmcf-and-constructed-genus-0-s-ref-x-y-z">
<h2>7. Quantifying the similarity between the cMCF and constructed genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span><a class="headerlink" href="#quantifying-the-similarity-between-the-cmcf-and-constructed-genus-0-s-ref-x-y-z" title="Link to this heading">#</a></h2>
<p>The previous operations of shrinkwrapping and remeshing through voxelization changes the parameterization of the two surfaces i.e. they are not the same meshes with different number of vertices and faces. However it should not greatly change the bijectivity of the surfaces i.e. they describe or 1-to-1 to the same underlying shape (albeit the genus-0 may be slightly dilated / smoother e.g. to avoid shape features).</p>
<p>To check:</p>
<ol class="arabic simple">
<li><p>we can plot the vertices of the original and remeshed surface to check geometric similarity.</p></li>
<li><p>We can also compute several quantitative metrics to check the geometric similarity to the original surface.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.plotting</span> <span class="k">as</span> <span class="nn">plotting</span> <span class="c1"># we import this so we can make x,y,z axes be plotted in equal proportions. </span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="n">sampling</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># plot every just so its not fully dense in the plot so we don&#39;t see anything!</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;S_ref before (black) vs after remeshing (green)&#39;</span><span class="p">)</span>
<span class="c1"># plotting the before</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># plotting the after</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;S_ref before (black) vs after remeshing (green)&#39;</span><span class="p">)</span>
<span class="c1"># plotting the before</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># plotting the after</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6645b60cc9ae6043f466e81bee3951196a1d42749e33f7a360bd731bd77944f0.png" src="../_images/6645b60cc9ae6043f466e81bee3951196a1d42749e33f7a360bd731bd77944f0.png" />
<img alt="../_images/763afd512c864f6f268d7de042479db47948d42547f11feba531d44c96daf042.png" src="../_images/763afd512c864f6f268d7de042479db47948d42547f11feba531d44c96daf042.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">igl</span> 
<span class="c1"># measure the geometric differences</span>

<span class="c1"># 1. mean squared error or Chamfer distance</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">chamfer_distance_point_cloud</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean squared error (chamfer distance): &#39;</span><span class="p">,</span> <span class="n">mse</span><span class="p">)</span> <span class="c1"># in terms of pixels </span>

<span class="c1"># 2. diff surface area</span>
<span class="n">diff_A</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">diff_area_trimesh_trimesh</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="p">,</span> <span class="n">cMCF_Sref_remesh</span><span class="p">)</span>
<span class="n">fraction_A</span> <span class="o">=</span> <span class="n">diff_A</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">igl</span><span class="o">.</span><span class="n">doublearea</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">cMCF_Sref</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span> <span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fraction total surface area change: &#39;</span><span class="p">,</span> <span class="n">fraction_A</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mean squared error (chamfer distance):  1.7718253
fraction total surface area change:  -0.022664958798817025
</pre></div>
</div>
</div>
</div>
</section>
<section id="mapping-measurements-onto-the-genus-0-s-ref-x-y-z">
<h2>8. Mapping measurements onto the genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span><a class="headerlink" href="#mapping-measurements-onto-the-genus-0-s-ref-x-y-z" title="Link to this heading">#</a></h2>
<p>The genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> is the tightest approximation of cMCF <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span>. Therefore we can establish a 1-1 correspondence by performing mesh matching. This involves finding for every vertex of the genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span>, the face in cMCF <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> it will intersect with if we shoot a normal ray to the surface. Where they ray hits can be described by local barycentric coordinates, allowing us to interpolate any measurements of cMCF <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> by interpolation.</p>
<p>Since cMCF is bijective to the original surface (by virtue of recording the deformation history), <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> vertices coordinates can be transfered as measurements onto the genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> like any other signal such as curvature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># u-Unwrap3D provides a single convenience function to perform mesh matching between two meshes and then if provided, barycentric interpolation to transfer numerical + label-based measurements</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Example 1: Reinterpolating the surface mean curvature of S(x,y,z) and/or its coloring</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Load the curvature values computed from Step 0</span>
<span class="n">curvature_stats_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell_surface_folder</span><span class="p">,</span> 
                                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_surface_curvature_intensity_stats&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">))</span> 
<span class="n">surf_H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">curvature_stats_file</span><span class="p">)[</span><span class="s2">&quot;surf_H&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="c1"># Get the colors used in S(x,y,z) for curvature and cast to float32 for interpolation</span>
<span class="n">surf_H_colors</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> 

<span class="c1"># performing the matching + transfer</span>
<span class="c1"># u-Unwrap3D provides a one-function call for transferring these numerical measurements + label-based measurements </span>

<span class="c1"># concatenate all numerical together, so that number of columns = number of measurements</span>
<span class="n">source_numerical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">surf_H</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> 
                              <span class="n">surf_H_colors</span><span class="p">])</span>

<span class="c1"># transferring cMCF_Sref to cMCF_Sref_remesh</span>
<span class="n">match_params</span><span class="p">,</span> <span class="n">transferred_numerical</span><span class="p">,</span> <span class="n">transferred_labels</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">transfer_mesh_measurements</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="p">,</span> 
                                                                                               <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                                                                <span class="n">source_mesh_vertex_scalars</span><span class="o">=</span><span class="n">source_numerical</span><span class="p">,</span>
                                                                                                <span class="n">source_mesh_vertex_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># we don&#39;t have any label measurements</span>

<span class="n">remesh_S_ref_H</span> <span class="o">=</span> <span class="n">transferred_numerical</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">remesh_S_ref_H_color_interp</span> <span class="o">=</span> <span class="n">transferred_numerical</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>For recoloring the genus-0 <span class="math notranslate nohighlight">\(S_\text{ref}(x,y,z)\)</span> we can either apply a colormap to the reinterpolated mean curvature values, or use the interpolated colors directly.</p>
<p>Option 1 is the more accurate, as the generation of the original colormap likely involved clipping the raw values, but involves extra lines of code. Since it is for visualization, option 2 is quicker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Option 1: reapply a colormap based on the reinterpolated curvature values, </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">remesh_S_ref_H_color</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">remesh_S_ref_H</span><span class="o">/</span><span class="mf">.104</span><span class="p">,</span> <span class="c1"># .104 is the voxel_size </span>
                                             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">,</span> 
                                             <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                                             <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># this gives output in 0-1</span>
<span class="n">remesh_S_ref_H_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mf">255.</span><span class="o">*</span><span class="n">remesh_S_ref_H_color</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">])</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Option 2: use interpolated colors</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">remesh_S_ref_H_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">remesh_S_ref_H_color_interp</span><span class="p">)</span> <span class="c1"># cast back to uint8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">add the colors to the cMCF_Sref_remesh and export out a .obj mesh file for visualization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># we now add this color to the remeshed S_ref</span>
<span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">remesh_S_ref_H_color</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                     <span class="s1">&#39;unwrap_cMCF_Sref_mesh_H_color.obj&#39;</span><span class="p">))</span>

<span class="c1"># we can also save this remapped curvature value for use in downstream computations e.g. for optimizing the unwrapping axis after spherical parameterization</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                         <span class="s1">&#39;unwrap_cMCF_remapped_surf_H.mat&#39;</span><span class="p">),</span> 
                        <span class="p">{</span><span class="s1">&#39;surf_H&#39;</span> <span class="p">:</span> <span class="n">remesh_S_ref_H</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>We show a second example, interpolating the vertex coordinates of <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> as a 3-dimensional signal on the genus-0 <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> mesh. <strong>Note:</strong> this is in fact a form of parameterization !</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Example 2: Reinterpolating the coordinates of S(x,y,z) onto the genus-0 S_ref(x,y,z) by treating it as scalar signals. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># since in the previous, we performed transfer of the curvature, we can reuse the match_params</span>
<span class="n">remesh_S_ref_input_xyz</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">mesh_vertex_interpolate_scalar</span><span class="p">(</span><span class="n">cMCF_Sref</span><span class="p">,</span> 
                                                                   <span class="n">match_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                                   <span class="n">match_params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                                   <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of vertices on genus-0 S_ref geometry: &#39;</span><span class="p">,</span> <span class="n">remesh_S_ref_input_xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of vertices in original surface: &#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="c1"># Visualize the colocalization of points. The original mesh will be quasi-conformally mapped.</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;S(x,y,z) (black) and mapped to remeshed S_ref(x,y,z) (green)&#39;</span><span class="p">)</span>
<span class="c1"># plotting the before</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># plotting the after</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">remesh_S_ref_input_xyz</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">remesh_S_ref_input_xyz</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">remesh_S_ref_input_xyz</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">cMCF_Sref_input_remesh</span> <span class="o">=</span> <span class="n">cMCF_Sref_remesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cMCF_Sref_input_remesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">remesh_S_ref_input_xyz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">cMCF_Sref_input_remesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                             <span class="s1">&#39;remapped_input_surface_onto_cMCF_Sref_mesh_H_color.obj&#39;</span><span class="p">))</span>


<span class="c1"># we can quantify the similarity between the transferred coordinates and the actual input surface</span>

<span class="c1"># 1. mean squared error or Chamfer distance</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">chamfer_distance_point_cloud</span><span class="p">(</span><span class="n">remesh_S_ref_input_xyz</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean squared error (chamfer distance): &#39;</span><span class="p">,</span> <span class="n">mse</span><span class="p">)</span> <span class="c1"># in terms of pixels </span>

<span class="c1"># 2. diff surface area</span>
<span class="n">diff_A</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">diff_area_trimesh_trimesh</span><span class="p">(</span><span class="n">cMCF_Sref_input_remesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
<span class="n">fraction_A</span> <span class="o">=</span> <span class="n">diff_A</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">igl</span><span class="o">.</span><span class="n">doublearea</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span> <span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fraction total surface area change: &#39;</span><span class="p">,</span> <span class="n">fraction_A</span><span class="p">)</span> 
  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>number of vertices on genus-0 S_ref geometry:  (18198, 3)
number of vertices in original surface:  (23864, 3)
</pre></div>
</div>
<img alt="../_images/7652527d5476e695fe3e979683c7f10c953bcedface4cd8765ff7472c7f6eaf7.png" src="../_images/7652527d5476e695fe3e979683c7f10c953bcedface4cd8765ff7472c7f6eaf7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mean squared error (chamfer distance):  1.4446409
fraction total surface area change:  -0.021063772918917697
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./03_basic_workflow"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Step0_find_cell_surface_from_segmentation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Step 0: Segmenting a single cell from a volume image</p>
      </div>
    </a>
    <a class="right-next"
       href="Step2_quasiconformal_spherical_parameterization.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-surface-mesh-s-x-y-z">1. Read in surface mesh, <span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-conformalized-mean-curvature-flow-cmcf-on-s-x-y-z">2. Run conformalized mean curvature flow (cMCF) on <span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-reference-shape-determination-using-discrete-gaussian-curvature">3. Automatic reference shape determination using discrete Gaussian curvature</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-conformal-and-equiareal-distortion-errors-during-cmcf">4. Quantifying conformal and equiareal distortion errors during cMCF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-conformal-and-equiareal-distortion-error-of-s-ref-x-y-z">5. Quantifying the conformal and equiareal distortion error of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-a-genus-0-s-ref-x-y-z-surface-using-shrinkwrapping-and-voxelization">6. Constructing a genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> surface using shrinkwrapping and voxelization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-similarity-between-the-cmcf-and-constructed-genus-0-s-ref-x-y-z">7. Quantifying the similarity between the cMCF and constructed genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-measurements-onto-the-genus-0-s-ref-x-y-z">8. Mapping measurements onto the genus-0 <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Felix Y. Zhou
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://github.com/fyz11/u-Unwrap3D_notebooks/blob/main/LICENSE" target="_blank">GPL3</a> unless mentioned otherwise. 
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>