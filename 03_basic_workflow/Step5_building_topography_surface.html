
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Step 5: Building the topographic \((d,u,v)\) space of \(S_{ref}(x,y,z)\) &#8212; u-Unwrap3D Analysis Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_basic_workflow/Step5_building_topography_surface';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Step 6: Compute topographic surface \(S(d,u,v)\) from topographic binary segmentation" href="Step6_find_topographic_surface_mesh.html" />
    <link rel="prev" title="Step 4: UV mapping \(S_{ref}(x,y,z)\) into 2D using its spherical parameterization, \(S_{\text{ref}}^{\Omega}(x,y,z)\)" href="Step4_uv_mapping_spherical_parameterization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">u-Unwrap3D Analysis Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    u-Unwrap3D Analysis Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_installation/readme.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Standard Workflow</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Standard workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step0_find_cell_surface_from_segmentation.html">Step 0: Segmenting a single cell from a volume image</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step1_find_reference_surface.html">Step 1: Find and create a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step2_quasiconformal_spherical_parameterization.html">Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step3_equiareal_spherical_parameterization.html">Step 3: Quasi-equiareal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step4_uv_mapping_spherical_parameterization.html">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> into 2D using its spherical parameterization, <span class="math notranslate nohighlight">\(S_{\text{ref}}^{\Omega}(x,y,z)\)</span></a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Step 5: Building the topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="Step6_find_topographic_surface_mesh.html">Step 6: Compute topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> from topographic binary segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step7_topographic_cMCF_to_flatten.html">Step 7: Flattening the topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> onto the 2D plane</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="full_example_cells/readme.html">Full examples of standard workflow</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_bleb_cell.html">Example 1: Cell with blebs</a></li>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_lamellipodia_cell.html">Example 2: Cell with lamellipodia</a></li>
<li class="toctree-l2"><a class="reference internal" href="full_example_cells/unwrap_filopodia_cell.html">Example 3: Cell with filopodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Customizing the standard workflow to input data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_customizing_basic_workflow/readme.html">Customizing the standard workflow for downstream analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">In-depth Breakdown of Mapping Steps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_obtaining_surfaces/readme.html">Extracting surfaces from microscopy imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_find_reference_surface/readme.html">Finding the best reference shape for the analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_uv_parameterization/readme.html">UV unwrapping of spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_building_topography_space/readme.html">Building topography space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_spherical_parameterization/readme.html">Spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_flatten_topography_surface/readme.html">Flattening topography surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transporting measurements between representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../22_transporting_measurements/readme.html">Transferring measurements across meshes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applying u-Unwrap3D to live-cell imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../16_shape_registration/readme.html">Shape registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15_compute_distortion_corrected_uv_measurements/readme.html">Computing distortion-corrected measurements for analysis in uv and topopraphy space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20_surface_flow_analytics/readme.html">Motion and information flow of measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../19_tracking_in_uv/readme.html">Tracking protrusions in 2D uv space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../21_tracking_analytics/readme.html">Analyzing temporally tracked protrusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applications of different surface representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../13_segmenting_surface_protrusions/readme.html">Segmenting surface protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../13_segmenting_surface_protrusions/binary_segment_protrusions.html">Binary protrusion segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13_segmenting_surface_protrusions/instance_segment_protrusions.html">Instance protrusion segmentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../14_volumizing_reference_and_protrusions/readme.html">Decomposing surface into reference and protrusion meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../18_spherical_harmonics/readme.html">Harmonics analysis of surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mapping open 3D surfaces into 2D</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../12_unwrapping_individual_protrusions/readme.html">Unwrapping individual protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../12_unwrapping_individual_protrusions/unwrap_lamellipodia_protrusion.html">Example: Unwrapping a lamellipodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/glossary.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks/issues/new?title=Issue%20on%20page%20%2F03_basic_workflow/Step5_building_topography_surface.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/03_basic_workflow/Step5_building_topography_surface.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Step 5: Building the topographic (d,u,v) space of S_{ref}(x,y,z)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-s-x-y-z-s-text-ref-x-y-z-and-s-text-ref-u-v">1. Load <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> and <span class="math notranslate nohighlight">\(S_{\text{ref}}(u,v)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-the-topographic-space-d-u-v-of-s-text-ref-x-y-z">2. Constructing the topographic space, <span class="math notranslate nohighlight">\((d,u,v)\)</span> of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-specifying-the-stepsize">a. specifying the stepsize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-choice-of-distance-transform">b. choice of distance transform</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-measurements-of-v-x-y-z-into-the-topographic-space-d-u-v">3. Mapping measurements of <span class="math notranslate nohighlight">\(V(x,y,z)\)</span> into the topographic space <span class="math notranslate nohighlight">\((d,u,v)\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-visualizing-the-cartesian-x-y-z-space-mapped-by-topography-d-u-v-space">a. Visualizing the Cartesian <span class="math notranslate nohighlight">\((x,y,z)\)</span> space mapped by topography <span class="math notranslate nohighlight">\((d,u,v)\)</span> space</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-mapping-the-original-image-into-a-topographic-volume-image">b. Mapping the original image into a topographic volume image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-mapping-the-binary-cell-segmentation-into-a-topographic-binary-image">c. Mapping the binary cell segmentation into a topographic binary image</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="step-5-building-the-topographic-d-u-v-space-of-s-ref-x-y-z">
<h1>Step 5: Building the topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span><a class="headerlink" href="#step-5-building-the-topographic-d-u-v-space-of-s-ref-x-y-z" title="Link to this heading">#</a></h1>
<p>Using <span class="math notranslate nohighlight">\(S(u,v)\)</span>, the <span class="math notranslate nohighlight">\((u,v)\)</span> parameterization of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> we can propagate the surface along the steepest gradient of its signed distance transform in desired stepsizes to map the surrounding ‘normal’ space external and internal to the cell. This produces a ‘topographic’ volume representation that is particularly useful for analysing surface features.</p>
<p>This workbook shows how to build the topographic space to enable a topographic surface to be extracted as well as to map the original Cartesian volume image into a topographic volume image.</p>
<section id="load-s-x-y-z-s-text-ref-x-y-z-and-s-text-ref-u-v">
<h2>1. Load <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> and <span class="math notranslate nohighlight">\(S_{\text{ref}}(u,v)\)</span><a class="headerlink" href="#load-s-x-y-z-s-text-ref-x-y-z-and-s-text-ref-u-v" title="Link to this heading">#</a></h2>
<p>We assume the user has worked through step 4 which generates and saves the (u,v) parameterization of the reference surface <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> for an input cell surface mesh to the folder <code class="docutils literal notranslate"><span class="pre">example_results/bleb_example/step4_uv_mapping</span></code>. We also need the original image and its segmentation in the folder <code class="docutils literal notranslate"><span class="pre">../../example_data/img</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Utility_Functions.file_io</span> <span class="k">as</span> <span class="nn">fio</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Mesh.meshtools</span> <span class="k">as</span> <span class="nn">meshtools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span> 
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span>

<span class="c1"># example cell used</span>
<span class="n">imgfolder</span> <span class="o">=</span> <span class="s1">&#39;../../data/img&#39;</span>
<span class="n">imgfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgfolder</span><span class="p">,</span> <span class="s1">&#39;bleb_example.tif&#39;</span><span class="p">)</span>
<span class="n">basefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the filename with extension</span>

<span class="c1"># create the analysis save folder for this step</span>
<span class="n">savefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;example_results&#39;</span><span class="p">,</span> 
                         <span class="n">basefname</span><span class="p">,</span>
                         <span class="s1">&#39;step5_topographic_space&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder</span><span class="p">)</span> <span class="c1"># auto generates the specified folder structure if doesn&#39;t currently exist.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Loading</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># original image</span>
<span class="n">img_file</span> <span class="o">=</span> <span class="s1">&#39;../../data/img/</span><span class="si">%s</span><span class="s1">.tif&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>

<span class="c1"># original binary image file</span>
<span class="n">binary_img_file</span> <span class="o">=</span> <span class="s1">&#39;example_results/</span><span class="si">%s</span><span class="s1">/step0_cell_segmentation/</span><span class="si">%s</span><span class="s1">_binary_seg.tif&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">,</span> <span class="n">basefname</span><span class="p">)</span>
<span class="n">binary_img</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">binary_img_file</span><span class="p">)</span>

<span class="c1"># load the original surface which is used to determine the maximal extent to propagate out from the surface.</span>
<span class="n">surf_file</span> <span class="o">=</span> <span class="s1">&#39;example_results/</span><span class="si">%s</span><span class="s1">/step0_cell_segmentation/curvature_binary_mesh_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">,</span> <span class="n">basefname</span><span class="p">)</span>
<span class="n">surf_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">surf_file</span><span class="p">)</span>

<span class="c1"># load the genus-0 S_ref reference mesh that was sphere mapped</span>
<span class="n">surf_Sref_file</span> <span class="o">=</span> <span class="s1">&#39;example_results/</span><span class="si">%s</span><span class="s1">/step1_cMCF_reference/remapped_input_surface_onto_cMCF_Sref_mesh_H_color.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)</span>
<span class="n">surf_Sref_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">surf_Sref_file</span><span class="p">)</span>

<span class="c1"># load the pre-computed uv-mapping of S_ref(x,y,z)</span>
<span class="n">uv_folder</span> <span class="o">=</span> <span class="s1">&#39;example_results/</span><span class="si">%s</span><span class="s1">/step4_uv_mapping&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)</span>
<span class="n">uv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uv_folder</span><span class="p">,</span> 
                       <span class="s1">&#39;uv_mapping_params.mat&#39;</span><span class="p">)</span>
<span class="n">uv_map_obj</span> <span class="o">=</span> <span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">uv_file</span><span class="p">)</span> <span class="c1"># reads the .mat like a python dictionary. </span>

<span class="n">S_uv</span> <span class="o">=</span> <span class="n">uv_map_obj</span><span class="p">[</span><span class="s1">&#39;uv_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="constructing-the-topographic-space-d-u-v-of-s-text-ref-x-y-z">
<h2>2. Constructing the topographic space, <span class="math notranslate nohighlight">\((d,u,v)\)</span> of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span><a class="headerlink" href="#constructing-the-topographic-space-d-u-v-of-s-text-ref-x-y-z" title="Link to this heading">#</a></h2>
<p>The topographic space normal to <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> is constructed by propagating the uv-parameterized <span class="math notranslate nohighlight">\(S_{\text{ref}}(u,v)\)</span>, <span class="math notranslate nohighlight">\(D_{out}\)</span> steps outwards until it covers the most extremal protrusions of <span class="math notranslate nohighlight">\(S(x,y,z)\)</span> and <span class="math notranslate nohighlight">\(D_{in}\)</span> steps into the cell along the gradient of a specified distance transform. The distance transform used to propagate outwards need not be the same as that used for propagating inwards.</p>
<p>u-Unwrap3D computes the distance transform using the binary voxelization of the genus-0 <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span>.</p>
<section id="a-specifying-the-stepsize">
<h3>a. specifying the stepsize<a class="headerlink" href="#a-specifying-the-stepsize" title="Link to this heading">#</a></h3>
<p>Choosing too small a stepsize means long computing times. Choose too large a stepsize means sampling the surface protrusions without sufficient resolution.</p>
<p>By default, u-Unwrap3D attempts to set an optimal stepsize based on computing the mean voxel dimensions in 3D Cartesian space of a (u,v) pixel (<code class="docutils literal notranslate"><span class="pre">alpha_step=None</span></code>). Alternatively users may specify their own e.g. <code class="docutils literal notranslate"><span class="pre">alpha_step=1</span></code>.</p>
</section>
<section id="b-choice-of-distance-transform">
<h3>b. choice of distance transform<a class="headerlink" href="#b-choice-of-distance-transform" title="Link to this heading">#</a></h3>
<p>For outwards propagation, the shape of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> should be maintained, u-Unwrap3D recommends the Euclidean distance transform which is fast to compute, and forward Euler method of propagation <code class="docutils literal notranslate"><span class="pre">outer_method=forward_euler</span></code>.</p>
<p>For inwards propagation, if the shape of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> is convex without branches/protrusions, we can also use the Euclidean distance transform and forward Euler method of propagation as for outwards propagation. However, the shape of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> can have branches and protrusions, after cMCF. To handle also these cases u-Unwrap3D implements the harmonic distance transform, obtained by solving the Poisson equation, <code class="docutils literal notranslate"><span class="pre">inner_sdf_method</span> <span class="pre">=</span> <span class="pre">'harmonic'</span></code> together with backward Euler method of propagation using active contours, <code class="docutils literal notranslate"><span class="pre">active_contours</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Unzipping.unzip</span> <span class="k">as</span> <span class="nn">uzip</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Get the binary of S_ref</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Note If you saved the binary of S_ref, you can read this in, otherwise you need to voxelize the S_ref mesh. </span>
<span class="n">Sref_binary</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">voxelize_image_mesh_pts</span><span class="p">(</span><span class="n">surf_Sref_mesh</span><span class="p">,</span>
                                                <span class="n">dilate_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">erode_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">vol_shape</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the transpose is because, we extracted its surface after transposing the binary.</span>
<span class="n">S_mesh_pts</span> <span class="o">=</span> <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">topography_space</span><span class="p">,</span> <span class="p">(</span><span class="n">N_in</span><span class="p">,</span> <span class="n">N_out</span><span class="p">),</span> <span class="n">alpha_step</span> <span class="o">=</span> <span class="n">uzip</span><span class="o">.</span><span class="n">build_topography_space_from_Suv</span><span class="p">(</span><span class="n">S_uv</span><span class="p">,</span> 
                                                                                    <span class="n">Sref_binary</span><span class="p">,</span>
                                                                                    <span class="n">external_gradient_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># build if none, using Euclidean distance transform</span>
                                                                                    <span class="n">pad_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                                                                    <span class="n">alpha_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># use automatic method</span>
                                                                                    <span class="n">outer_surf_pts</span> <span class="o">=</span> <span class="n">S_mesh_pts</span><span class="p">,</span>
                                                                                    <span class="n">outer_n_dists</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># let this be auto determined. </span>
                                                                                    <span class="n">outer_pad_dist</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># the leeway.</span>
                                                                                    <span class="n">outer_method</span><span class="o">=</span><span class="s1">&#39;forward_euler&#39;</span><span class="p">,</span>
                                                                                    <span class="n">outer_smooth_win_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="c1"># we will smooth by minimum length of uv divide this factor. </span>
                                                                                    <span class="n">inner_n_dists</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="c1"># in voxels.</span>
                                                                                    <span class="n">inner_sdf_method</span> <span class="o">=</span> <span class="s1">&#39;harmonic&#39;</span><span class="p">,</span>
                                                                                    <span class="n">inner_source_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                                                                                    <span class="n">inner_harmonic_ds</span> <span class="o">=</span> <span class="mf">4.</span><span class="p">,</span> <span class="c1"># harmonic distance transform is memory-intensive and slow. Nearly always we must downsample so the volume is at most 256 x 256 x 256 voxels. 4x downsample by default. </span>
                                                                                    <span class="n">inner_method</span><span class="o">=</span><span class="s1">&#39;active_contours&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 45/45 [00:11&lt;00:00,  3.80it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>laplacian 3D construction... 2.926464319229126
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 25/25 [00:17&lt;00:00,  1.46it/s]
</pre></div>
</div>
</div>
</div>
<p>We can doublecheck the propagation has been computed properly by visualizing the wireframe of the surface for different values of <span class="math notranslate nohighlight">\(d\)</span>. We don’t need to plot every <span class="math notranslate nohighlight">\(d\)</span>, but sample it e.g. every 10</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check what is the dimensions of the topographic space</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;topographic space dimension: &#39;</span><span class="p">,</span> <span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the first </span><span class="si">%d</span><span class="s1"> slices are interior of S_ref&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">N_in</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the next </span><span class="si">%d</span><span class="s1"> slices are exterior of S_ref&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">N_out</span><span class="p">))</span>


<span class="c1"># use matplotlib and plot every 10th iteration wireframe surface to see the effect relative to the surface mesh.  </span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualize first the propagation outwards which is from N_in+1 onwards</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">Suv_prop_outside</span> <span class="o">=</span> <span class="n">topography_space</span><span class="p">[</span><span class="n">N_in</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">sampling</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Suv_prop_outside</span><span class="p">),</span> <span class="n">sampling</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">proj_type</span> <span class="o">=</span> <span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">aspect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># this works. </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># note the surface mesh vertices are inverse order to the image. </span>
    <span class="c1"># plot the propagated surface.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot_wireframe</span><span class="p">(</span><span class="n">Suv_prop_outside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                      <span class="n">Suv_prop_outside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">Suv_prop_outside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>topographic space dimension:  (71, 256, 512, 3)
the first 25 slices are interior of S_ref
the next 45 slices are exterior of S_ref
</pre></div>
</div>
<img alt="../_images/7dbf64a3206d31c1797cfef8d56aa05b6d8feba62ae0740f0ca6b07e301f60b9.png" src="../_images/7dbf64a3206d31c1797cfef8d56aa05b6d8feba62ae0740f0ca6b07e301f60b9.png" />
<img alt="../_images/9d0892f58189147b469754fcb1d6416b4bdc184cfbedf14ef29a4c9a5ee691c5.png" src="../_images/9d0892f58189147b469754fcb1d6416b4bdc184cfbedf14ef29a4c9a5ee691c5.png" />
<img alt="../_images/efed05b0c737062735d76cd84225e11e9cf1204944c01e29c94f27c7d7584744.png" src="../_images/efed05b0c737062735d76cd84225e11e9cf1204944c01e29c94f27c7d7584744.png" />
<img alt="../_images/976fe4079f3b19d4f1f118e63e806d26b060061951b0d85f88aa124f838dbef8.png" src="../_images/976fe4079f3b19d4f1f118e63e806d26b060061951b0d85f88aa124f838dbef8.png" />
<img alt="../_images/c77d65d2c946c2b66b01d101fae41e4a120a18b046273a1a9e56d9b67571d2f2.png" src="../_images/c77d65d2c946c2b66b01d101fae41e4a120a18b046273a1a9e56d9b67571d2f2.png" />
<img alt="../_images/cf3d16ae05c619291dcf49cc205603a19a212ee2ea39ffec3339202e2fdbf1dd.png" src="../_images/cf3d16ae05c619291dcf49cc205603a19a212ee2ea39ffec3339202e2fdbf1dd.png" />
<img alt="../_images/2f1cd1453d30a5a461b23eed6ea05f32498da661b52dc2fa9d30cb79b8763e0c.png" src="../_images/2f1cd1453d30a5a461b23eed6ea05f32498da661b52dc2fa9d30cb79b8763e0c.png" />
<img alt="../_images/08aebc2174b452215adeffceb483166b1e45f004a0eb9c7148cca3820d80b1a5.png" src="../_images/08aebc2174b452215adeffceb483166b1e45f004a0eb9c7148cca3820d80b1a5.png" />
<img alt="../_images/feb5c9f179de189597da5abc5d298d16a22adba40ed41f99b1ea82113286cd01.png" src="../_images/feb5c9f179de189597da5abc5d298d16a22adba40ed41f99b1ea82113286cd01.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use matplotlib and plot every 10th iteration wireframe surface to see the effect relative to the surface mesh with this inside surface propagation  </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualize second the propagation inwards which is from slice 0 to N_in+1, in reverse order.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">Suv_prop_inside</span> <span class="o">=</span> <span class="n">topography_space</span><span class="p">[:</span><span class="n">N_in</span><span class="o">+</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># remember to reverse order </span>

<span class="n">sampling</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Suv_prop_inside</span><span class="p">),</span> <span class="n">sampling</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">proj_type</span> <span class="o">=</span> <span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">aspect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># this works. </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># note the surface mesh vertices are inverse order to the image. </span>
    <span class="c1"># plot the propagated surface.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot_wireframe</span><span class="p">(</span><span class="n">Suv_prop_inside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                      <span class="n">Suv_prop_inside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">Suv_prop_inside</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/74d624c9b092d78b608163da8a072cc41864bb6cbe6048bfc5f3c255b70d38b8.png" src="../_images/74d624c9b092d78b608163da8a072cc41864bb6cbe6048bfc5f3c255b70d38b8.png" />
<img alt="../_images/d901f44505c1e1cf1aa667be3f2b533d00613843887458b60272b60ad0331cae.png" src="../_images/d901f44505c1e1cf1aa667be3f2b533d00613843887458b60272b60ad0331cae.png" />
<img alt="../_images/76c5656dc43b2485b8f24ac03778820b1fea99bb1eed6bfff9f826dd2f84e9a6.png" src="../_images/76c5656dc43b2485b8f24ac03778820b1fea99bb1eed6bfff9f826dd2f84e9a6.png" />
<img alt="../_images/0e56c135bf5cb21b3c520cbd25546e18f3cc9f81cac672b9a68e07aaead7ff2f.png" src="../_images/0e56c135bf5cb21b3c520cbd25546e18f3cc9f81cac672b9a68e07aaead7ff2f.png" />
<img alt="../_images/8a0617cc46aab6dd5f4e6970748dfd20d4450a27e8147d9dd1ca9bde58218f1c.png" src="../_images/8a0617cc46aab6dd5f4e6970748dfd20d4450a27e8147d9dd1ca9bde58218f1c.png" />
<img alt="../_images/38b2c66efdb8b020d1b9fb393f7d924445dfacc9ff7902792dbec58fe373113b.png" src="../_images/38b2c66efdb8b020d1b9fb393f7d924445dfacc9ff7902792dbec58fe373113b.png" />
</div>
</div>
</section>
</section>
<section id="mapping-measurements-of-v-x-y-z-into-the-topographic-space-d-u-v">
<h2>3. Mapping measurements of <span class="math notranslate nohighlight">\(V(x,y,z)\)</span> into the topographic space <span class="math notranslate nohighlight">\((d,u,v)\)</span><a class="headerlink" href="#mapping-measurements-of-v-x-y-z-into-the-topographic-space-d-u-v" title="Link to this heading">#</a></h2>
<p>The constructed <code class="docutils literal notranslate"><span class="pre">topography_space</span></code>, is an array of dimensions, <span class="math notranslate nohighlight">\((D,U,V,3)\)</span> whereby the 3 channels correspond to the Cartesian <span class="math notranslate nohighlight">\((x,y,z)\)</span> coordinates i.e. for every voxel of <span class="math notranslate nohighlight">\((d,u,v)\)</span> space, we know its corresponding <span class="math notranslate nohighlight">\((x,y,z) coordinate. Specifically, we have constructed a mapping of a `shell` volume around \)</span>S_{ref}(x,y,z)$.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">topography_space</span></code> with interpolation to pullback and visualize any scalar or label quantity of interest of Cartesian <span class="math notranslate nohighlight">\((x,y,z)\)</span> space in topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space with the huge huge advantage of seeing everything in the vicinity of the cell surface in a single field-of-view !</p>
<section id="a-visualizing-the-cartesian-x-y-z-space-mapped-by-topography-d-u-v-space">
<h3>a. Visualizing the Cartesian <span class="math notranslate nohighlight">\((x,y,z)\)</span> space mapped by topography <span class="math notranslate nohighlight">\((d,u,v)\)</span> space<a class="headerlink" href="#a-visualizing-the-cartesian-x-y-z-space-mapped-by-topography-d-u-v-space" title="Link to this heading">#</a></h3>
<p>We will assign a sequential coloring scheme to each <span class="math notranslate nohighlight">\((d,u,v)\)</span> coordinate and visualize the same coloring displayed on its corresponding <span class="math notranslate nohighlight">\((x,y,z)\)</span> position given by <code class="docutils literal notranslate"><span class="pre">topography_space</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generate coloring of the (d,u,v) space</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.colors</span> <span class="k">as</span> <span class="nn">vol_colors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> 

<span class="n">topographic_space_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="n">topographic_space_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">topographic_space_index</span><span class="p">,</span>
                                                             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">)[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>

<span class="c1"># check the mid-slices of the colormap to see how it looks in the three orthogonal views.</span>
<span class="n">topography_size</span> <span class="o">=</span> <span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;mid-slices of coloring in (d,u,v) topography space&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_space_color</span><span class="p">[</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_space_color</span><span class="p">[:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_space_color</span><span class="p">[:,:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d72b9ee46d7947d12de0a1dd5a3c1f1297efa86e0242f320a15f444fd32191d0.png" src="../_images/d72b9ee46d7947d12de0a1dd5a3c1f1297efa86e0242f320a15f444fd32191d0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Put the topographic coordinates, in their corresponding (x,y,z) coordinate and rasterized onto the image grid for display.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Now we initialise an array based on the size of the original cartesian volume image</span>
<span class="n">topographic_cartesian_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">binary_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># note the [::-1] is only because the original cell surface mesh was extracted after transposing the image</span>

<span class="c1">#populate the color using the topographic coordinates. for simplicity we cast the float to int.</span>
<span class="n">topographic_cartesian_color</span><span class="p">[</span><span class="n">topography_space</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> 
                            <span class="n">topography_space</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> 
                            <span class="n">topography_space</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span> <span class="o">=</span> <span class="n">topographic_space_color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="n">img_size</span> <span class="o">=</span> <span class="n">binary_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># the mesh was derived from the image transpose</span>


<span class="c1"># Now we take a look at the topography space mapped into the volume, with the mesh points corresponding to the same slice overlaid</span>
<span class="c1"># We see the covering is good except as expected the North/South poles where we expect undersampling. </span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_cartesian_color</span><span class="p">[</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:])</span>
<span class="c1"># map all the points of mesh in this view in 2D</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_cartesian_color</span><span class="p">[:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:])</span>
<span class="c1"># map all the points of mesh in this view in 2D</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_cartesian_color</span><span class="p">[:,:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e2ebf18ce52868ac5d328ce98f330d87d1fd467fd1553d831b759d78bb2e5d19.png" src="../_images/e2ebf18ce52868ac5d328ce98f330d87d1fd467fd1553d831b759d78bb2e5d19.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we can also overlay the mesh with the cross-sections of the actual image too</span>

<span class="n">img_transpose</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_transpose</span><span class="p">[</span><span class="n">img_transpose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_transpose</span><span class="p">[:,</span><span class="n">img_transpose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="c1"># map all the points of mesh in this view in 2D</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_transpose</span><span class="p">[:,:,</span><span class="n">img_transpose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">select_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
         <span class="n">surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">select_pts</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dc924b027a506ceb0606fe55f8bd22cef35e88edd52237afa3d4d3f05e305805.png" src="../_images/dc924b027a506ceb0606fe55f8bd22cef35e88edd52237afa3d4d3f05e305805.png" />
</div>
</div>
</section>
<section id="b-mapping-the-original-image-into-a-topographic-volume-image">
<h3>b. Mapping the original image into a topographic volume image<a class="headerlink" href="#b-mapping-the-original-image-into-a-topographic-volume-image" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Image_Functions.image</span> <span class="k">as</span> <span class="nn">image_fn</span>

<span class="n">topographic_I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)[</span><span class="o">...</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># again the ::-1 to reverse the coordinates, so they map correctly to the cell in the original image </span>
                                                       <span class="n">grid_shape</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                       <span class="n">I_ref</span><span class="o">=</span><span class="n">img</span><span class="p">))</span>
<span class="n">topographic_I</span> <span class="o">=</span> <span class="n">topographic_I</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># we can save this for viewing </span>
<span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> <span class="s1">&#39;topographic_intensity_I_img.tif&#39;</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">topographic_I</span><span class="p">))</span>

<span class="n">img_size</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># redefining image size, because we choose to flip the coordinates of topography space</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\fyz11\AppData\Local\Temp\ipykernel_2320\3525422746.py:9: UserWarning: example_results\bleb_example\step5_topographic_space\topographic_intensity_I_img.tif is a low contrast image
  skio.imsave(os.path.join(savefolder, &#39;topographic_intensity_I_img.tif&#39;),
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize the mid cross sections of topographic and original cartesian.</span>
<span class="c1"># Note the upside-down of the image: this is because we use the convention 1st d slice = innermost of cell, last d slice = outermost of cell</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Topographic mid cross-section intensities&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_I</span><span class="p">[</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_I</span><span class="p">[:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_I</span><span class="p">[:,:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cartesian mid cross-section intensities&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3e0adfb789966537a029910d0e0e8ede5c7b3467624a8bc3092662360b1ef9e9.png" src="../_images/3e0adfb789966537a029910d0e0e8ede5c7b3467624a8bc3092662360b1ef9e9.png" />
<img alt="../_images/49a54813f5e22b27285b658304675567ea2ca5e3a5eeed73f7aa58748c493348.png" src="../_images/49a54813f5e22b27285b658304675567ea2ca5e3a5eeed73f7aa58748c493348.png" />
</div>
</div>
</section>
<section id="c-mapping-the-binary-cell-segmentation-into-a-topographic-binary-image">
<h3>c. Mapping the binary cell segmentation into a topographic binary image<a class="headerlink" href="#c-mapping-the-binary-cell-segmentation-into-a-topographic-binary-image" title="Link to this heading">#</a></h3>
<p>We can also map label measurements, not necessarily just scalar measurements. For labels, we use nearest neighbor interpolation by setting <code class="docutils literal notranslate"><span class="pre">method='nearest'</span></code> in <code class="docutils literal notranslate"><span class="pre">unwrap3D.Image_Functions.image.map_intensity_interp3</span></code>.</p>
<p>Alternatively, for binary segmentation we can make it uint8 i.e. 0 = background, 255 = cell, interpolate, then re-binarize the output with cutoff of 128.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Image_Functions.image</span> <span class="k">as</span> <span class="nn">image_fn</span>

<span class="n">topographic_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)[</span><span class="o">...</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># again the ::-1 to reverse the coordinates, so they map correctly to the cell in the original image </span>
                                                       <span class="n">grid_shape</span><span class="o">=</span><span class="n">binary_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                                       <span class="n">I_ref</span><span class="o">=</span><span class="n">binary_img</span><span class="p">))</span>
<span class="n">topographic_binary</span> <span class="o">=</span> <span class="n">topographic_binary</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">topography_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># visualize the mid cross sections of topographic and original cartesian.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Topographic mid cross-section segmentation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">topographic_binary</span><span class="p">[:,:,</span><span class="n">topography_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cartesian mid cross-section segmentation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">binary_img</span><span class="p">[</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">binary_img</span><span class="p">[:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">binary_img</span><span class="p">[:,:,</span><span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/875d6bf592938b6d3abcd20069ad9ca2003d783f2cd3db7b450ab15e2928108d.png" src="../_images/875d6bf592938b6d3abcd20069ad9ca2003d783f2cd3db7b450ab15e2928108d.png" />
<img alt="../_images/4c4726ffc0ef1ab324cee78b553a9fb80f5d66395105febb3d5b19f51a33fdb0.png" src="../_images/4c4726ffc0ef1ab324cee78b553a9fb80f5d66395105febb3d5b19f51a33fdb0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finally we save the constructed topographic coordinates - we will use this next to map the original segmentation binary and derive a topographic surface mesh</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Save the basic parameters for replication. </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="s1">&#39;topographic_volume_space.mat&#39;</span><span class="p">),</span> 
             <span class="p">{</span><span class="s1">&#39;topographic_map&#39;</span><span class="p">:</span> <span class="n">topography_space</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
              <span class="s1">&#39;uv_map_file&#39;</span><span class="p">:</span> <span class="n">uv_file</span><span class="p">,</span> 
              <span class="s1">&#39;N_inside&#39;</span><span class="p">:</span> <span class="n">N_in</span><span class="p">,</span> 
              <span class="s1">&#39;N_outside&#39;</span><span class="p">:</span> <span class="n">N_out</span><span class="p">,</span>
              <span class="s1">&#39;alpha_step&#39;</span><span class="p">:</span> <span class="n">alpha_step</span><span class="p">})</span> 
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./03_basic_workflow"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Step4_uv_mapping_spherical_parameterization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> into 2D using its spherical parameterization, <span class="math notranslate nohighlight">\(S_{\text{ref}}^{\Omega}(x,y,z)\)</span></p>
      </div>
    </a>
    <a class="right-next"
       href="Step6_find_topographic_surface_mesh.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Step 6: Compute topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> from topographic binary segmentation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-s-x-y-z-s-text-ref-x-y-z-and-s-text-ref-u-v">1. Load <span class="math notranslate nohighlight">\(S(x,y,z)\)</span>, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span> and <span class="math notranslate nohighlight">\(S_{\text{ref}}(u,v)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-the-topographic-space-d-u-v-of-s-text-ref-x-y-z">2. Constructing the topographic space, <span class="math notranslate nohighlight">\((d,u,v)\)</span> of <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-specifying-the-stepsize">a. specifying the stepsize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-choice-of-distance-transform">b. choice of distance transform</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-measurements-of-v-x-y-z-into-the-topographic-space-d-u-v">3. Mapping measurements of <span class="math notranslate nohighlight">\(V(x,y,z)\)</span> into the topographic space <span class="math notranslate nohighlight">\((d,u,v)\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-visualizing-the-cartesian-x-y-z-space-mapped-by-topography-d-u-v-space">a. Visualizing the Cartesian <span class="math notranslate nohighlight">\((x,y,z)\)</span> space mapped by topography <span class="math notranslate nohighlight">\((d,u,v)\)</span> space</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-mapping-the-original-image-into-a-topographic-volume-image">b. Mapping the original image into a topographic volume image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-mapping-the-binary-cell-segmentation-into-a-topographic-binary-image">c. Mapping the binary cell segmentation into a topographic binary image</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Felix Y. Zhou
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://github.com/fyz11/u-Unwrap3D_notebooks/blob/main/LICENSE" target="_blank">GPL3</a> unless mentioned otherwise. 
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>