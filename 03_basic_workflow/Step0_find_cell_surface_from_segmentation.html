
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Segmenting a single cell from a volume image &#8212; u-Unwrap3D Analysis Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_basic_workflow/Step0_find_cell_surface_from_segmentation';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Step 1: Creating a genus-0 reference surface, \(S_{ref}(x,y,z)\) using conformalized mean curvature flow" href="Step1_find_reference_surface.html" />
    <link rel="prev" title="Basic workflow for unwrapping 3D surfaces" href="readme.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">u-Unwrap3D Analysis Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    u-Unwrap3D Analysis Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_installation/readme.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic Workflow</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="readme.html">Basic workflow for unwrapping 3D surfaces</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Segmenting a single cell from a volume image</a></li>

<li class="toctree-l2"><a class="reference internal" href="Step1_find_reference_surface.html">Step 1: Creating a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> using conformalized mean curvature flow</a></li>

<li class="toctree-l2"><a class="reference internal" href="Step2_quasiconformal_spherical_parameterization.html">Step 2: Quasi-conformal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>

<li class="toctree-l2"><a class="reference internal" href="Step3_equiareal_spherical_parameterization.html">Step 3: Quasi-equiareal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>

<li class="toctree-l2"><a class="reference internal" href="Step4_uv_mapping_spherical_parameterization.html">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> using its equiareal spherical parameterization, <span class="math notranslate nohighlight">\(S_{\Omega}(x,y,z)\)</span></a></li>

<li class="toctree-l2"><a class="reference internal" href="Step5_building_topography_surface.html">Step 5: Building a topographic volume <span class="math notranslate nohighlight">\(V(d,u,v)\)</span> space using the <span class="math notranslate nohighlight">\((u,v)\)</span> parameterized <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>

<li class="toctree-l2"><a class="reference internal" href="Step6_find_topographic_surface_mesh.html">Step 6: Extract topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> given the topographic volume <span class="math notranslate nohighlight">\(V(d,u,v)\)</span> space</a></li>

</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Customizing the Basic Workflow to input data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_customizing_basic_workflow/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">In-depth Breakdown of Mapping Steps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_obtaining_surfaces/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_find_reference_surface/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_uv_parameterization/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_building_topography_space/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_spherical_parameterization/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_flatten_topography_surface/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transporting measurements between representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../22_transporting_measurements/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applying u-Unwrap3D to live-cell imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../16_shape_registration/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15_compute_distortion_corrected_uv_measurements/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20_surface_flow_analytics/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../19_tracking_in_uv/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../21_tracking_analytics/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applications of different surface representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../13_segmenting_surface_protrusions/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14_volumizing_reference_and_protrusions/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../18_spherical_harmonics/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mapping open 3D surfaces into 2D</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../12_unwrapping_individual_protrusions/readme.html">Basic workflow for unwrapping 3D surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/glossary.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks/issues/new?title=Issue%20on%20page%20%2F03_basic_workflow/Step0_find_cell_surface_from_segmentation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/03_basic_workflow/Step0_find_cell_surface_from_segmentation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Segmenting a single cell from a volume image</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Segmenting a single cell from a volume image</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#binary-segmentation-with-otsu-thresholding">Binary segmentation with Otsu thresholding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-curvature-measurement-from-binary-segmentation">Mean curvature measurement from binary segmentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surface-meshing-the-binary-segmentation-and-mapping-the-curvature-onto-the-mesh">Surface meshing the binary segmentation and mapping the curvature onto the mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-surface-proximal-membrane-signals-by-traversing-along-the-steepest-gradient-descent-normal-into-the-cell">Mapping surface proximal membrane signals by traversing along the steepest gradient descent normal into the cell</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#we-now-proceed-to-step-1-notebook-to-run-conformalized-mean-curvature-flow-and-derive-a-genus-0-reference-shape">We now proceed to step 1 notebook to run conformalized mean curvature flow and derive a genus-0 reference shape …</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="segmenting-a-single-cell-from-a-volume-image">
<h1>Segmenting a single cell from a volume image<a class="headerlink" href="#segmenting-a-single-cell-from-a-volume-image" title="Link to this heading">#</a></h1>
<p>In order to remap a cell surface in u-Unwrap3D, the cell must be first segmented from the volumetric image and a surface mesh created. This workbook walks through this process.</p>
<section id="binary-segmentation-with-otsu-thresholding">
<h2>Binary segmentation with Otsu thresholding<a class="headerlink" href="#binary-segmentation-with-otsu-thresholding" title="Link to this heading">#</a></h2>
<p>We read in the volume image used in Fig.1 of the paper and also create a savefolder to store the results of analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span> 
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 

<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.volume_img</span> <span class="k">as</span> <span class="nn">vol_img_viz</span> <span class="c1"># for creating a montage maximum projection</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Utility_Functions.file_io</span> <span class="k">as</span> <span class="nn">fio</span> <span class="c1"># for common IO functions</span>

<span class="n">imgfolder</span> <span class="o">=</span> <span class="s1">&#39;example_data/img&#39;</span>
<span class="n">imgfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgfolder</span><span class="p">,</span> <span class="s1">&#39;bleb_example.tif&#39;</span><span class="p">)</span>

<span class="n">basefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the filename with extension</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Initialise a save folder to store the important outputs for the result of the pipeline.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">savefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;example_results&#39;</span><span class="p">,</span> 
                         <span class="n">basefname</span><span class="p">,</span>
                         <span class="s1">&#39;step0_cell_segmentation&#39;</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder</span><span class="p">)</span> <span class="c1"># auto generates the specified folder structure if doesn&#39;t currently exist.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Read and display image</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># read the image using scikit-image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>

<span class="c1"># utility function in u-Unwrap3D to generate a montage maximum projection of the 3 orthogonal views for display</span>
<span class="n">img_proj</span> <span class="o">=</span> <span class="n">vol_img_viz</span><span class="o">.</span><span class="n">montage_vol_proj</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Montage maximum projection&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_proj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                        <span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;_max-proj_three.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8d7d74fc0fa5ffe0ef313b018450c4b381c9f8063c6f58f92176f7e7d377fa7d.png" src="../_images/8d7d74fc0fa5ffe0ef313b018450c4b381c9f8063c6f58f92176f7e7d377fa7d.png" />
</div>
</div>
<p>Since the signal-to-noise ratio of this is good, we segment with an intensity threshold automatically determined from Otsu’s method from the scikit-image library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Segmentation.segmentation</span> <span class="k">as</span> <span class="nn">segmentation</span> <span class="c1"># import the segmentation submodule which wraps the Otsu method</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndimage</span> <span class="c1"># use instead of scikit-image for faster morphological operations in 3D</span>
<span class="kn">import</span> <span class="nn">skimage.morphology</span> <span class="k">as</span> <span class="nn">skmorph</span>

<span class="c1"># returns the binary and the auto determined threshold. </span>
<span class="n">img_binary</span><span class="p">,</span> <span class="n">img_binary_thresh</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">segment_vol_thresh</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># erode by ball kernel radius = 1 to make a tighter binary</span>
<span class="n">img_binary</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">img_binary</span><span class="p">,</span> 
                                    <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                    <span class="n">structure</span><span class="o">=</span><span class="n">skmorph</span><span class="o">.</span><span class="n">ball</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">img_binary_proj</span> <span class="o">=</span> <span class="n">vol_img_viz</span><span class="o">.</span><span class="n">montage_vol_proj</span><span class="p">(</span><span class="n">img_binary</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Montage binary segmentation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_binary_proj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                         <span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;_binary_three.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Save the binary out as a uint8 .tif</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                         <span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;_binary_seg.tif&#39;</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">img_binary</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/22e1fd613550e95d15f8a526754b7f022df72d4d3de6a836ed876b1f36c9f33e.png" src="../_images/22e1fd613550e95d15f8a526754b7f022df72d4d3de6a836ed876b1f36c9f33e.png" />
</div>
</div>
</section>
<section id="mean-curvature-measurement-from-binary-segmentation">
<h2>Mean curvature measurement from binary segmentation<a class="headerlink" href="#mean-curvature-measurement-from-binary-segmentation" title="Link to this heading">#</a></h2>
<p>Measuring mean curvature from a mesh involves fitting a local plane to neighborhood vertices. As such the result is subject to the quality of the triangle faces and choice of neighborhood radius. We find it easier and more accurate for downstream quantification to apply the continuous definition of mean curvature, <span class="math notranslate nohighlight">\(H\)</span></p>
<div class="math notranslate nohighlight">
\[ H = {-\frac{1}{2} \nabla \cdot \hat{n}} \]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{n}\)</span> is the unit surface normal vector, and also the gradient of the signed distance function <span class="math notranslate nohighlight">\(\Phi\)</span> of the binary segmentation.</p>
<div class="math notranslate nohighlight">
\[ \hat{n} = {\nabla \Phi} \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the continuous mean curvature definition and smooth slightly with a Gaussian of sigma=3.  </span>
<span class="n">H_binary</span><span class="p">,</span> <span class="n">H_sdf_vol_normal</span><span class="p">,</span> <span class="n">H_sdf_vol</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">mean_curvature_binary</span><span class="p">(</span><span class="n">img_binary</span><span class="p">,</span> 
                                                                           <span class="n">smooth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                                                           <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># if mask=True, only the curvature of a thin shell (+/-smooth) around the binary segmentation is returned. </span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">H_binary</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">H_binary</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">H_binary</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># if mask=True above, the following line is necessary to enable interpolation.</span>
<span class="n">H_binary</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">H_binary</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\s205272\AppData\Local\Temp\ipykernel_9880\2889383254.py:8: RuntimeWarning: Mean of empty slice
  plt.imshow(np.nanmean(H_binary,axis=0), cmap=&#39;Spectral_r&#39;); plt.grid(&#39;off&#39;); plt.axis(&#39;off&#39;)
C:\Users\s205272\AppData\Local\Temp\ipykernel_9880\2889383254.py:10: RuntimeWarning: Mean of empty slice
  plt.imshow(np.nanmean(H_binary,axis=1), cmap=&#39;Spectral_r&#39;); plt.grid(&#39;off&#39;); plt.axis(&#39;off&#39;)
C:\Users\s205272\AppData\Local\Temp\ipykernel_9880\2889383254.py:12: RuntimeWarning: Mean of empty slice
  plt.imshow(np.nanmean(H_binary,axis=2), cmap=&#39;Spectral_r&#39;); plt.grid(&#39;off&#39;); plt.axis(&#39;off&#39;)
</pre></div>
</div>
<img alt="../_images/24d3334370eca71b5feb65e5ab34ada84312d7c295c2c0fb68e32e0de7e77364.png" src="../_images/24d3334370eca71b5feb65e5ab34ada84312d7c295c2c0fb68e32e0de7e77364.png" />
</div>
</div>
</section>
<section id="surface-meshing-the-binary-segmentation-and-mapping-the-curvature-onto-the-mesh">
<h2>Surface meshing the binary segmentation and mapping the curvature onto the mesh<a class="headerlink" href="#surface-meshing-the-binary-segmentation-and-mapping-the-curvature-onto-the-mesh" title="Link to this heading">#</a></h2>
<p>We mesh the binary segmentation with Marching Cubes at an isovalue of 0.5 and also apply remeshing to obtain regular equilateral triangle faces. We color the surface according to the mean curvature calculated above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Mesh.meshtools</span> <span class="k">as</span> <span class="nn">meshtools</span> <span class="c1"># load in the meshtools submodule</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Image_Functions.image</span> <span class="k">as</span> <span class="nn">image_fn</span> <span class="c1"># for common image processing functions</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.colors</span> <span class="k">as</span> <span class="nn">vol_colors</span> <span class="c1"># this is for colormapping any np.array using a color palette </span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># this is for specifying a matplotlib color palette</span>

<span class="n">img_binary_surf_mesh</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">marching_cubes_mesh_binary</span><span class="p">(</span><span class="n">img_binary</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># The transpose is to be consistent with ImageJ rendering and Matlab convention  </span>
                                                                <span class="n">presmooth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="c1"># applies a presmooth</span>
                                                                <span class="n">contourlevel</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
                                                                <span class="n">remesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                <span class="n">remesh_method</span><span class="o">=</span><span class="s1">&#39;pyacvd&#39;</span><span class="p">,</span> 
                                                                <span class="n">remesh_samples</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="c1"># remeshing with a target #vertices = 90% of original</span>
                                                                <span class="n">predecimate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># this applies quadric mesh simplication to remove very small edges before remeshing</span>
                                                                <span class="n">min_mesh_size</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span>
                                                                <span class="n">upsamplemethod</span><span class="o">=</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span> <span class="c1"># upsample the mesh if after the simplification and remeshing &lt; min_mesh_size  </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A quick way to check the genus is to get the euler number. The genus of the mesh is related to the euler number by</span>
<span class="sd">A genus-0 mesh should have euler number = 2</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Euler characteristic of mesh is: &#39;</span><span class="p">,</span> <span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">euler_number</span><span class="p">)</span> <span class="c1">#should be 2 if genus is 0</span>

<span class="c1"># we also provide a more comprehensive function for common mesh properties</span>
<span class="n">mesh_property</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">measure_props_trimesh</span><span class="p">(</span><span class="n">img_binary_surf_mesh</span><span class="p">,</span> <span class="n">main_component</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="n">mesh_property</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">We interpolate the mean curvature at the mesh vertex points using trilinear interpolation and convert this to a colormap to &#39;paint&#39; onto the mesh</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># interpolation </span>
<span class="n">surf_H</span> <span class="o">=</span> <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># undo the transpose to be consistent with the volume</span>
                                            <span class="n">grid_shape</span><span class="o">=</span> <span class="n">H_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                            <span class="n">I_ref</span><span class="o">=</span> <span class="n">H_binary</span><span class="p">,</span> 
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> 
                                            <span class="n">cast_uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># we generate colors from the mean curvature </span>
<span class="n">surf_H_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">surf_H</span><span class="o">/</span><span class="mf">.104</span><span class="p">,</span> <span class="c1"># 0.104 is the voxel resolution -&gt; this converts to um^-1 </span>
                                      <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">,</span> 
                                      <span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span> 
                                      <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span> <span class="c1"># colormap H with lower and upper limit of -1, 1 um^-1. </span>

<span class="c1"># set the vertex colors to the computed mean curvature color</span>
<span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">surf_H_colors</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span> 

<span class="c1"># save the mesh for viewing in an external program such as meshlab which offers much better rendering capabilities</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> <span class="s1">&#39;curvature_binary_mesh_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span><span class="p">))</span> <span class="c1"># tmp is used to prevent printing to screen.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Euler characteristic of mesh is:  2
{&#39;convex&#39;: False, &#39;volume&#39;: True, &#39;watertight&#39;: True, &#39;orientability&#39;: True, &#39;euler_number&#39;: 2, &#39;genus&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the mesh is best viewed in a dedicated mesh viewer such as meshlab which is opensource, free and cross-platform. We can get an idea by plotting and coloring the mesh vertices using matplotlib</span>

<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.plotting</span> <span class="k">as</span> <span class="nn">plotting</span> <span class="c1"># we import this so we can make x,y,z axes be plotted in equal proportions. </span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="n">surf_H</span><span class="o">/</span><span class="mf">.104</span><span class="p">,</span> 
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral_r&#39;</span><span class="p">,</span> 
           <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
           <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8bea29abca65b571af8a29d2da9aaab67a5681bdd102339b90a1c751ae226270.png" src="../_images/8bea29abca65b571af8a29d2da9aaab67a5681bdd102339b90a1c751ae226270.png" />
</div>
</div>
</section>
<section id="mapping-surface-proximal-membrane-signals-by-traversing-along-the-steepest-gradient-descent-normal-into-the-cell">
<h2>Mapping surface proximal membrane signals by traversing along the steepest gradient descent normal into the cell<a class="headerlink" href="#mapping-surface-proximal-membrane-signals-by-traversing-along-the-steepest-gradient-descent-normal-into-the-cell" title="Link to this heading">#</a></h2>
<p>We can use active contour conformalized mean curvature flow to traverse into the cell and sample the image intensity at designed step sizes <span class="math notranslate nohighlight">\(\alpha\)</span>. We can then average the sampled intensity and map this onto the cell surface. We do this for our cell up to 1um depth. Our image has an isotropic voxel resolution of 0.104um. We sample this depth in steps of 0.5 voxels. This equates to a total of 2/0.104 steps rounded down to the nearest integer.</p>
<p>This sampling procedure is more precise than performing spherical nearest neighbor lookup which oversmooths the signal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_samples</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="mf">.104</span> <span class="c1"># total number of steps</span>
<span class="n">stepsize</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># voxels</span>
    
<span class="c1"># flip the mesh vertex coordinates so that it aligns with the volume size </span>
<span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># run the active contour cMCF to get the coordinates at different depths into the cell according to the external image gradient given by the gradient of the signed distance function.</span>
<span class="n">v_depth</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">parametric_mesh_constant_img_flow</span><span class="p">(</span><span class="n">img_binary_surf_mesh</span><span class="p">,</span> 
                                                      <span class="n">external_img_gradient</span> <span class="o">=</span> <span class="n">H_sdf_vol_normal</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
                                                      <span class="n">niters</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span><span class="o">/</span><span class="n">stepsize</span><span class="p">),</span> 
                                                      <span class="n">deltaL</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span> <span class="c1"># delta which controls the stiffness of the mesh</span>
                                                      <span class="n">step_size</span><span class="o">=</span><span class="n">stepsize</span><span class="p">,</span> 
                                                      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="c1"># this specifies the cMCF solver.</span>
                                                      <span class="n">conformalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># ensure we use the cMCF Laplacian</span>

<span class="c1"># we can check the size of the array</span>
<span class="nb">print</span><span class="p">(</span><span class="n">v_depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># we can plot the trajectory with matplotlib </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████████████████████████████████| 19/19 [30:29&lt;00:00, 96.26s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(159346, 3, 20)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the intensities at the sampled depth coordinates. </span>
<span class="n">v_depth_I</span> <span class="o">=</span> <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">v_depth</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> 
                                            <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                            <span class="n">I_ref</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
<span class="n">v_depth_I</span> <span class="o">=</span> <span class="n">v_depth_I</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">v_depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># matrix reshaping into a nicer shape. </span>

<span class="c1"># postprocess to check the total distance from the surface does not exceed the desired and replace any nans.  </span>
<span class="n">dist_v_depth0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_depth</span> <span class="o">-</span> <span class="n">v_depth</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">valid_I</span> <span class="o">=</span> <span class="n">dist_v_depth0</span><span class="o">&lt;=</span><span class="n">n_samples</span>
<span class="n">v_depth_I</span><span class="p">[</span><span class="n">valid_I</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># replace with nans</span>


<span class="c1"># compute the mean sampled intensity which will be taken as the surface intensity. </span>
<span class="n">surf_intensity_img_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">v_depth_I</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">surf_intensity_img_raw</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">surf_intensity_img_raw</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># for visualization, we find the intensity range to be more pleasing if clipped to between the 1st and 99th percentile. </span>
<span class="n">I_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">surf_intensity_img_raw</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">I_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">surf_intensity_img_raw</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span>

<span class="n">surf_intensity_img_raw_colors</span> <span class="o">=</span> <span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">surf_intensity_img_raw</span><span class="p">,</span> 
                                                      <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlBu_r</span><span class="p">,</span>   
                                                      <span class="n">vmin</span><span class="o">=</span><span class="n">I_min</span><span class="p">,</span> 
                                                      <span class="n">vmax</span><span class="o">=</span><span class="n">I_max</span><span class="p">)</span>
<span class="c1"># create a new surface mesh, now with the PI3K molecular signal colors. </span>
<span class="n">img_binary_surf_mesh_colors</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="n">faces</span><span class="o">=</span><span class="n">img_binary_surf_mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> 
                                                  <span class="n">vertex_colors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">surf_intensity_img_raw_colors</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">]))</span> 
<span class="n">tmp</span> <span class="o">=</span> <span class="n">img_binary_surf_mesh_colors</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                                                <span class="s1">&#39;PI3K_binary_mesh_&#39;</span><span class="o">+</span><span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span><span class="p">))</span> <span class="c1"># tmp is used to prevent printing to screen.</span>


<span class="c1"># again we can quickly view the coloring in matplotlib</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">img_binary_surf_mesh_colors</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
           <span class="n">img_binary_surf_mesh_colors</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">img_binary_surf_mesh_colors</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
           <span class="n">c</span><span class="o">=</span><span class="n">surf_intensity_img_raw</span><span class="p">,</span> 
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">,</span> 
           <span class="n">vmin</span><span class="o">=-</span><span class="n">I_min</span><span class="p">,</span>
           <span class="n">vmax</span><span class="o">=</span><span class="n">I_max</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># finally we will save the actual numerical values of the surface curvature and intensity to avoid recomputation to use for other steps of the pipeline</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span> <span class="c1"># we save in .mat, this will allow matlab users to use the output if desired</span>
<span class="n">spio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span> 
                          <span class="n">basefname</span><span class="o">+</span><span class="s1">&#39;_surface_curvature_intensity_stats.mat&#39;</span><span class="p">),</span> 
            <span class="p">{</span><span class="s1">&#39;surf_H&#39;</span><span class="p">:</span> <span class="n">surf_H</span><span class="p">,</span>
             <span class="s1">&#39;surf_intensity&#39;</span> <span class="p">:</span> <span class="n">surf_intensity_img_raw</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/32241278364dbc3054a5502738b0ee19ad18801ed546887824999301ee08056a.png" src="../_images/32241278364dbc3054a5502738b0ee19ad18801ed546887824999301ee08056a.png" />
</div>
</div>
</section>
</section>
<section id="we-now-proceed-to-step-1-notebook-to-run-conformalized-mean-curvature-flow-and-derive-a-genus-0-reference-shape">
<h1>We now proceed to step 1 notebook to run conformalized mean curvature flow and derive a genus-0 reference shape …<a class="headerlink" href="#we-now-proceed-to-step-1-notebook-to-run-conformalized-mean-curvature-flow-and-derive-a-genus-0-reference-shape" title="Link to this heading">#</a></h1>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-unwrap3D_test-py"
        },
        kernelOptions: {
            name: "conda-env-unwrap3D_test-py",
            path: "./03_basic_workflow"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-unwrap3D_test-py'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="readme.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Basic workflow for unwrapping 3D surfaces</p>
      </div>
    </a>
    <a class="right-next"
       href="Step1_find_reference_surface.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Step 1: Creating a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> using conformalized mean curvature flow</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Segmenting a single cell from a volume image</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#binary-segmentation-with-otsu-thresholding">Binary segmentation with Otsu thresholding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-curvature-measurement-from-binary-segmentation">Mean curvature measurement from binary segmentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surface-meshing-the-binary-segmentation-and-mapping-the-curvature-onto-the-mesh">Surface meshing the binary segmentation and mapping the curvature onto the mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-surface-proximal-membrane-signals-by-traversing-along-the-steepest-gradient-descent-normal-into-the-cell">Mapping surface proximal membrane signals by traversing along the steepest gradient descent normal into the cell</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#we-now-proceed-to-step-1-notebook-to-run-conformalized-mean-curvature-flow-and-derive-a-genus-0-reference-shape">We now proceed to step 1 notebook to run conformalized mean curvature flow and derive a genus-0 reference shape …</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Felix Y. Zhou
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://github.com/fyz11/u-Unwrap3D_notebooks/blob/main/LICENSE" target="_blank">GPL3</a> unless mentioned otherwise. 
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>