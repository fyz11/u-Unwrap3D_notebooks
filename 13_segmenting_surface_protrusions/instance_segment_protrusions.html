
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Instance protrusion segmentation &#8212; u-Unwrap3D Analysis Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '13_segmenting_surface_protrusions/instance_segment_protrusions';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Decomposing surface into reference and protrusion meshes" href="../14_volumizing_reference_and_protrusions/readme.html" />
    <link rel="prev" title="Binary protrusion segmentation" href="binary_segment_protrusions.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">u-Unwrap3D Analysis Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    u-Unwrap3D Analysis Notebooks
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_installation/readme.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Standard Workflow</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/readme.html">Standard workflow for unwrapping 3D surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step0_find_cell_surface_from_segmentation.html">Step 0: Segmenting a single cell from a volume image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step1_find_reference_surface.html">Step 1: Find and create a genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step2_quasiconformal_spherical_parameterization.html">Step 2: Quasi-conformal spherical parameterization of the genus-0 reference surface, <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step3_equiareal_spherical_parameterization.html">Step 3: Quasi-equiareal spherical parameterization of a genus-0 surface, <span class="math notranslate nohighlight">\(S_{\text{ref}}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step4_uv_mapping_spherical_parameterization.html">Step 4: UV mapping <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span> into 2D using its spherical parameterization, <span class="math notranslate nohighlight">\(S_{\text{ref}}^{\Omega}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step5_building_topography_surface.html">Step 5: Building the topographic <span class="math notranslate nohighlight">\((d,u,v)\)</span> space of <span class="math notranslate nohighlight">\(S_{ref}(x,y,z)\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step6_find_topographic_surface_mesh.html">Step 6: Compute topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> from topographic binary segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_basic_workflow/Step7_topographic_cMCF_to_flatten.html">Step 7: Flattening the topographic surface <span class="math notranslate nohighlight">\(S(d,u,v)\)</span> onto the 2D plane</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03_basic_workflow/full_example_cells/readme.html">Full examples of standard workflow</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_basic_workflow/full_example_cells/unwrap_bleb_cell.html">Example 1: Cell with blebs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_basic_workflow/full_example_cells/unwrap_lamellipodia_cell.html">Example 2: Cell with lamellipodia</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_basic_workflow/full_example_cells/unwrap_filopodia_cell.html">Example 3: Cell with filopodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Customizing the standard workflow to input data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_customizing_basic_workflow/readme.html">Customizing the standard workflow for downstream analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">In-depth Breakdown of Mapping Steps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_obtaining_surfaces/readme.html">Extracting surfaces from microscopy imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_find_reference_surface/readme.html">Finding the best reference shape for the analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_uv_parameterization/readme.html">UV unwrapping of spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_building_topography_space/readme.html">Building topography space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_spherical_parameterization/readme.html">Spherical parameterizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_flatten_topography_surface/readme.html">Flattening topography surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transporting measurements between representations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../22_transporting_measurements/readme.html">Transferring measurements across meshes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applying u-Unwrap3D to live-cell imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../16_shape_registration/readme.html">Shape registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15_compute_distortion_corrected_uv_measurements/readme.html">Computing distortion-corrected measurements for analysis in uv and topopraphy space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20_surface_flow_analytics/readme.html">Motion and information flow of measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../19_tracking_in_uv/readme.html">Tracking protrusions in 2D uv space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../21_tracking_analytics/readme.html">Analyzing temporally tracked protrusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Applications of different surface representations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="readme.html">Segmenting surface protrusions</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="binary_segment_protrusions.html">Binary protrusion segmentation</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Instance protrusion segmentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../14_volumizing_reference_and_protrusions/readme.html">Decomposing surface into reference and protrusion meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../18_spherical_harmonics/readme.html">Harmonics analysis of surfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mapping open 3D surfaces into 2D</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../12_unwrapping_individual_protrusions/readme.html">Unwrapping individual protrusions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../12_unwrapping_individual_protrusions/unwrap_lamellipodia_protrusion.html">Example: Unwrapping a lamellipodia</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/glossary.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fyz11/u-Unwrap3D_notebooks/issues/new?title=Issue%20on%20page%20%2F13_segmenting_surface_protrusions/instance_segment_protrusions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/13_segmenting_surface_protrusions/instance_segment_protrusions.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Instance protrusion segmentation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-the-surface-mesh">0. Read in the surface mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-mean-curvature-and-binary-segmentation">1. Measure mean curvature and binary segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s-x-y-z"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connected-component-analysis-to-label-unique-protrusion-tips">2. Connected component analysis to label unique protrusion tips</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#postprocessing-and-diffusion-of-protrusion-tips-segmentation">3. Postprocessing and diffusion of protrusion tips segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s-d-u-v"><span class="math notranslate nohighlight">\(S(d,u,v)\)</span></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="instance-protrusion-segmentation">
<h1>Instance protrusion segmentation<a class="headerlink" href="#instance-protrusion-segmentation" title="Link to this heading">#</a></h1>
<p>The task of instance segmentation is to assign to each vertex (or alternatively face) of a mesh a positive integer id with each unique integer id corresponding to a unique protrusion. u-Unwrap3D assumes the convention that the label 0 is used to denote vertices/faces not part of a protrusion i.e. background. Labels &gt; 0 are foreground i.e. all are protrusions.</p>
<p>We will do instance segmentation by:</p>
<ol class="arabic simple">
<li><p>binary segment protrusion tips as that of the highest positive mean curvature</p></li>
<li><p>applying connected component analysis to assign binary segmented tips to unique protrusions</p></li>
<li><p>applying diffusion to propagate this seed labeling to cover the rest of the protrusion</p></li>
</ol>
<div class="alert alert-block alert-info"> 
<b>NOTE</b> The procedure is equally applicable whether we use $S(x,y,z)$ or its topography $S(d,u,v)$. However if using we need handle the boundary conditions to avoid a single protrusion being allocated two labels only because of the seam cut.    
</div>
<p>The mesh we we will use to demonstrate is <code class="docutils literal notranslate"><span class="pre">../../data/mesh/lamellipodia_cell.obj</span></code>, as well as its corresponding topography mesh <code class="docutils literal notranslate"><span class="pre">../../data/mesh/topography/curvature_topographic_mesh_lamellipodia_cell.obj</span></code>. The method demonstrated generalizes for all protrusions, but may require tweaking of parameters.</p>
<section id="read-in-the-surface-mesh">
<h2>0. Read in the surface mesh<a class="headerlink" href="#read-in-the-surface-mesh" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unwrap3D.Mesh.meshtools</span> <span class="k">as</span> <span class="nn">meshtools</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Analysis_Functions.topography</span> <span class="k">as</span> <span class="nn">topotools</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Segmentation.segmentation</span> <span class="k">as</span> <span class="nn">segmentation</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Image_Functions.image</span> <span class="k">as</span> <span class="nn">image_fn</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Utility_Functions.file_io</span> <span class="k">as</span> <span class="nn">fio</span> <span class="c1"># for common IO functions</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Unzipping.unzip</span> <span class="k">as</span> <span class="nn">uzip</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.colors</span> <span class="k">as</span> <span class="nn">vol_colors</span>
<span class="kn">import</span> <span class="nn">unwrap3D.Visualisation.plotting</span> <span class="k">as</span> <span class="nn">plotting</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> 
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span> 
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span> 

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Specifying image file location and parsing its name. </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">meshfolder</span> <span class="o">=</span> <span class="s1">&#39;../../data/mesh&#39;</span>
<span class="n">meshfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meshfolder</span><span class="p">,</span> <span class="s1">&#39;lamellipodia_cell.obj&#39;</span><span class="p">)</span>

<span class="n">basefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">meshfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.obj&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the filename with extension</span>

<span class="n">mesh_S</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">meshfile</span><span class="p">,</span>
                             <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># read only the largest if there is multiple separate objects in the mesh</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Also get its topography mesh</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">topo_meshfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meshfolder</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">,</span> <span class="s1">&#39;curvature_topographic_mesh_lamellipodia_cell.obj&#39;</span><span class="p">)</span>
<span class="n">mesh_S_duv</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">(</span><span class="n">topo_meshfile</span><span class="p">,</span> 
                                 <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Also its topography binary volume and the topography space</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># read the topography volume image of the cell </span>
<span class="n">binary_topography_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meshfolder</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">,</span> <span class="s1">&#39;topography_binary.tif&#39;</span><span class="p">)</span>
<span class="n">binary_topography_volume</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">binary_topography_file</span><span class="p">)</span>

<span class="c1"># read the topography space </span>
<span class="n">topography_space_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meshfolder</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">,</span> <span class="s1">&#39;topographic_volume_space.mat&#39;</span><span class="p">)</span>
<span class="n">topography_space_obj</span> <span class="o">=</span> <span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">topography_space_file</span><span class="p">)</span>

<span class="n">topographic_coordinates</span> <span class="o">=</span> <span class="n">topography_space_obj</span><span class="p">[</span><span class="s1">&#39;topographic_map&#39;</span><span class="p">]</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Create a master save folder</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">savefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;example_results&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;instance segmentation&#39;</span><span class="p">,</span>
                         <span class="n">basefname</span><span class="p">)</span>
<span class="n">fio</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savefolder</span><span class="p">)</span> <span class="c1"># auto generates the specified folder structure if doesn&#39;t currently exist.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualize the input mesh</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh_S_duv</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
            <span class="n">mesh_S_duv</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">mesh_S_duv</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">mesh_S_duv</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cf2261e3a07a6bae90d85a91abc61e9dc5cae8d58ed460074722e9af582d4668.png" src="../_images/cf2261e3a07a6bae90d85a91abc61e9dc5cae8d58ed460074722e9af582d4668.png" />
</div>
</div>
</section>
<section id="measure-mean-curvature-and-binary-segmentation">
<h2>1. Measure mean curvature and binary segmentation<a class="headerlink" href="#measure-mean-curvature-and-binary-segmentation" title="Link to this heading">#</a></h2>
<p>The objective is to identify tips or ridges of protrusions which are characterized by high positive mean curvature. We can identify them by applying kmeans clustering to the mean curvature measured either in Cartesian or topography space. The higher the number of clusters, <span class="math notranslate nohighlight">\(K\)</span> the finer the binning of mean curvature values and consequently we can set a higher cutoff using the class with highest mean curvature.</p>
<p>We perform this after voxelization the mesh so that we can use image-based connected component analysis algorithms.</p>
<section id="s-x-y-z">
<h3><span class="math notranslate nohighlight">\(S(x,y,z)\)</span><a class="headerlink" href="#s-x-y-z" title="Link to this heading">#</a></h3>
<p>We first voxelize to get a binary volume from the mesh and use kmeans cluster to detect the positive protrusion tips using k=5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># voxelize to get a binary</span>
<span class="n">mesh_S_binary</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">voxelize_image_mesh_pts</span><span class="p">(</span><span class="n">mesh_S</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                                  <span class="n">dilate_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                  <span class="n">erode_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># compute curvature for the entire binary</span>
<span class="n">H_surf_S</span><span class="p">,</span> <span class="p">(</span><span class="n">H_binary_3D_S</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">compute_mean_curvature_from_binary</span><span class="p">(</span><span class="n">mesh_S</span><span class="p">,</span> 
                                                                <span class="n">mesh_S_binary</span><span class="p">,</span> 
                                                                <span class="n">smooth_gradient</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                                                <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                                                                <span class="n">invert_H</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                <span class="n">return_H_img</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">H_binary_3D_S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">H_binary_3D_S</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># impute nans </span>


<span class="c1"># perform clustering on a shell volume around the surface, more equals setting a higher curvature threshold</span>
<span class="n">n_clusters</span><span class="o">=</span> <span class="mi">3</span>
<span class="c1"># this is another critical parameter in that it allows multi-scale smoothing of the curvature, this can help to segment protrusions over a larger area like lamellipodia</span>
<span class="n">smooth_curvature_sigma</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">5.</span><span class="p">]</span> 

<span class="n">depth_binary_mask</span><span class="p">,</span> <span class="n">H_binary_clusters</span> <span class="o">=</span> <span class="n">topotools</span><span class="o">.</span><span class="n">segment_topography_vol_curvature_surface</span><span class="p">(</span><span class="n">H_binary_3D_S</span><span class="p">,</span> 
                                                                                                <span class="n">mesh_S_binary</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
                                                                                                <span class="n">depth_ksize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># this is the size of shell around the surface </span>
                                                                                                <span class="n">smooth_curvature_sigma</span><span class="o">=</span><span class="n">smooth_curvature_sigma</span><span class="p">,</span> <span class="c1"># multiscale. allows for multiscale</span>
                                                                                                <span class="n">seg_method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span> <span class="c1"># or gmm</span>
                                                                                                <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="c1"># number of voxel points to sample</span>
                                                                                                <span class="n">n_classes</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="c1"># number of Kmeans cluster</span>
                                                                                                <span class="n">scale_feats</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">H_binary_clusters</span> <span class="o">=</span> <span class="n">topotools</span><span class="o">.</span><span class="n">remove_topography_segment_objects_binary</span><span class="p">(</span><span class="n">H_binary_clusters</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">H_binary_clusters</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># use the highest cluster id (most positive) </span>
                                                                        <span class="n">minsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1"># minimum size in voxels.</span>
                                                                        <span class="n">uv_params_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># don&#39;t use if in cartesian, else can use to convert topo to cartesian here</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_binary_mask</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">H_binary_clusters</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/460b9d2f5c96ce95f1d060bc08a03807cdcd4217df00d92d259bf17d3c51b496.png" src="../_images/460b9d2f5c96ce95f1d060bc08a03807cdcd4217df00d92d259bf17d3c51b496.png" />
</div>
</div>
</section>
</section>
<section id="connected-component-analysis-to-label-unique-protrusion-tips">
<h2>2. Connected component analysis to label unique protrusion tips<a class="headerlink" href="#connected-component-analysis-to-label-unique-protrusion-tips" title="Link to this heading">#</a></h2>
<p>Apply image connected component analysis on the binary volume segmentation of the curvature in Cartesian or topography space to assign unique ids to each contiguous spatial region. These will form the ‘seeds’ for each individual protrusion and will be diffused in the next step to capture the rest of the protrusion.</p>
<section id="id1">
<h3><span class="math notranslate nohighlight">\(S(x,y,z)\)</span><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skimage.measure</span> <span class="k">as</span> <span class="nn">skmeasure</span> 
<span class="kn">import</span> <span class="nn">skimage.segmentation</span> <span class="k">as</span> <span class="nn">sksegmentation</span>
<span class="kn">import</span> <span class="nn">skimage.morphology</span> <span class="k">as</span> <span class="nn">skmorph</span> 
<span class="kn">import</span> <span class="nn">igl</span>

<span class="c1"># connected component analysis, then label expansion, to help label a bit more. before diffusion on the mesh</span>
<span class="n">H_binary_clusters_positive_tips</span> <span class="o">=</span> <span class="n">H_binary_clusters</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">H_binary_clusters</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># gate with binary, remove small regions</span>
<span class="n">protrusion_tips</span> <span class="o">=</span> <span class="n">mesh_S_binary</span> <span class="o">*</span> <span class="n">H_binary_clusters_positive_tips</span>
<span class="n">protrusion_tips</span> <span class="o">=</span> <span class="n">skmorph</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span><span class="n">protrusion_tips</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">protrusion_tips</span> <span class="o">=</span> <span class="n">skmeasure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">protrusion_tips</span><span class="p">)</span>
<span class="n">protrusion_tips</span> <span class="o">=</span> <span class="n">sksegmentation</span><span class="o">.</span><span class="n">expand_labels</span><span class="p">(</span><span class="n">protrusion_tips</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># to visualize assign colors. </span>
<span class="n">max_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">protrusion_tips</span><span class="p">)</span>
<span class="n">protrusion_tips_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">protrusion_tips</span><span class="p">,</span> 
                                                            <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">,</span> <span class="c1"># use the hsv map. </span>
                                                            <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                            <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">vmax</span><span class="o">=</span><span class="n">max_label</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_binary_mask</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">protrusion_tips_color</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">putting the volume-based segmentation back onto the mesh, color and export for visualization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">protrusion_labels</span> <span class="o">=</span> <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                    <span class="n">grid_shape</span><span class="o">=</span><span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                    <span class="n">I_ref</span><span class="o">=</span><span class="n">protrusion_tips</span><span class="p">,</span> 
                                                    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> 
                                                    <span class="n">cast_uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># assign colors for export</span>
<span class="n">protrusion_labels_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">protrusion_labels</span><span class="p">,</span> 
                                                                        <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">,</span> 
                                                                        <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                                        <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">max_label</span><span class="p">))[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
<span class="c1"># assign gray to background</span>
<span class="n">protrusion_labels_color</span><span class="p">[</span><span class="n">protrusion_labels</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])[</span><span class="kc">None</span><span class="p">,:]</span> 


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">colors are redundant, to help distinguish individual protrusions it is better to not color the boundary of each protrusion, setting the color to black</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># boundary loop finding works on faces. </span>
<span class="n">face_labels</span> <span class="o">=</span>  <span class="n">image_fn</span><span class="o">.</span><span class="n">map_intensity_interp3</span><span class="p">(</span><span class="n">igl</span><span class="o">.</span><span class="n">barycenter</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                            <span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">),</span> 
                                                        <span class="n">grid_shape</span><span class="o">=</span><span class="n">mesh_S_binary</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                        <span class="n">I_ref</span><span class="o">=</span><span class="n">protrusion_tips</span><span class="p">,</span> <span class="c1"># do we need to expand labels to be able to sample onto mesh. </span>
                                                        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> 
                                                        <span class="n">cast_uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">uniq_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">face_labels</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># find all vertices associated with boundary and set the color on vertex to black</span>
<span class="n">vertex_set_0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">uniq_labels</span><span class="p">:</span>
    <span class="n">b_loop</span> <span class="o">=</span> <span class="n">igl</span><span class="o">.</span><span class="n">boundary_loop</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">[</span><span class="n">face_labels</span><span class="o">==</span><span class="n">lab</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_loop</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">vertex_set_0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_loop</span><span class="p">)</span>
<span class="n">vertex_set_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">vertex_set_0</span><span class="p">))</span>


<span class="n">protrusion_labels_color</span><span class="p">[</span><span class="n">vertex_set_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,:]</span> <span class="c1"># set all the boundaries to black</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">finally export the mesh with color</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">protrusion_labels_mesh</span> <span class="o">=</span> <span class="n">mesh_S</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">protrusion_labels_color</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                         <span class="s1">&#39;instance_segmentation_initial_Cartesian_3D_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualize in matplotlib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e25062fb31f0e8f5dcd28cbaf77e682b51d4227aa116b649e0d79711107df39f.png" src="../_images/e25062fb31f0e8f5dcd28cbaf77e682b51d4227aa116b649e0d79711107df39f.png" />
<img alt="../_images/bab11c79ede2414352d89d85410a2cb92af5ae9cf9f921586a74c6581e9deec1.png" src="../_images/bab11c79ede2414352d89d85410a2cb92af5ae9cf9f921586a74c6581e9deec1.png" />
</div>
</div>
</section>
</section>
<section id="postprocessing-and-diffusion-of-protrusion-tips-segmentation">
<h2>3. Postprocessing and diffusion of protrusion tips segmentation<a class="headerlink" href="#postprocessing-and-diffusion-of-protrusion-tips-segmentation" title="Link to this heading">#</a></h2>
<p>u-Unwrap3D adapts <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.semi_supervised.LabelSpreading.html">labelspreading</a> to diffuse the protrusion steps for <span class="math notranslate nohighlight">\(n\)</span> steps on a surface mesh given an affinity matrix based on distance and local convexity to refine segmentation to capture more of the protrusions.</p>
<section id="id2">
<h3><span class="math notranslate nohighlight">\(S(x,y,z)\)</span><a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Filter out small detected protrusions we don&#39;t wish to diffuse</span>
<span class="n">protrusion_labels_final</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">remove_small_mesh_components_labels</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                                        <span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> 
                                                                        <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># this the background label</span>
                                                                        <span class="n">labels</span><span class="o">=</span><span class="n">protrusion_labels</span><span class="p">,</span> <span class="c1"># label </span>
                                                                        <span class="n">vertex_labels_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># True, since we are passing vertex based labels</span>
                                                                        <span class="n">physical_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># filter by actual surface area</span>
                                                                        <span class="n">minsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># set smallish</span>
                                                                        <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># if there are disconnected regions assigned the same label, keep only the largest</span>


<span class="c1"># 2. construct affinity graph and diffuse labels for N iterations.</span>
<span class="n">W_geometry</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">vertex_geometric_affinity_matrix</span><span class="p">(</span><span class="n">protrusion_labels_mesh</span><span class="p">,</span> 
                                                                <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                                                <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> 
                                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="c1"># &lt;0.5 biases towards convexity</span>
                                                                <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="n">protrusion_labels_final</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">labelspreading_mesh</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
                                                        <span class="n">f</span><span class="o">=</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> 
                                                        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">))[</span><span class="n">protrusion_labels_final</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># exclude the background.</span>
                                                        <span class="n">y</span><span class="o">=</span><span class="n">protrusion_labels_final</span><span class="p">[</span><span class="n">protrusion_labels_final</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> 
                                                        <span class="n">W</span><span class="o">=</span><span class="n">W_geometry</span><span class="p">,</span> 
                                                        <span class="n">niters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># how many iterations, 10 for the dendritic example</span>
                                                        <span class="n">alpha_prop</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="c1"># clamping factor, if 1 output identical to input. </span>
                                                        <span class="n">return_proba</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                        <span class="n">renorm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 3. Second round of filtering out small detected protrusions</span>
<span class="n">protrusion_labels_final</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">remove_small_mesh_components_labels</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> 
                                                                        <span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> 
                                                                        <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># this the background label</span>
                                                                        <span class="n">labels</span><span class="o">=</span><span class="n">protrusion_labels_final</span><span class="p">,</span> <span class="c1"># label </span>
                                                                        <span class="n">vertex_labels_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># True, since we are passing vertex based labels</span>
                                                                        <span class="n">physical_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># filter by actual surface area</span>
                                                                        <span class="n">minsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># set smallish</span>
                                                                        <span class="n">keep_largest_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># if there are disconnected regions assigned the same label, keep only the largest</span>

<span class="c1"># 4. output the mesh with refined labels and its colors</span>
<span class="c1"># assign colors for export</span>
<span class="n">protrusion_labels_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">vol_colors</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">protrusion_labels_final</span><span class="p">,</span> 
                                                            <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">,</span> 
                                                            <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                            <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">max_label</span><span class="p">))[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
<span class="c1"># assign gray to background</span>
<span class="n">protrusion_labels_color</span><span class="p">[</span><span class="n">protrusion_labels_final</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])[</span><span class="kc">None</span><span class="p">,:]</span> 


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">again, blacken vertices part of boundary loop</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">spstats</span>
<span class="c1"># calculate face labels by taking the mode</span>
<span class="n">face_labels</span> <span class="o">=</span>  <span class="n">spstats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">protrusion_labels_final</span><span class="p">[</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">uniq_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">face_labels</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># find all vertices associated with boundary and set the color on vertex to black</span>
<span class="n">vertex_set_0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">uniq_labels</span><span class="p">:</span>
    <span class="n">b_loop</span> <span class="o">=</span> <span class="n">igl</span><span class="o">.</span><span class="n">boundary_loop</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">faces</span><span class="p">[</span><span class="n">face_labels</span><span class="o">==</span><span class="n">lab</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_loop</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">vertex_set_0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_loop</span><span class="p">)</span>
<span class="n">vertex_set_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">vertex_set_0</span><span class="p">))</span>

<span class="n">protrusion_labels_color</span><span class="p">[</span><span class="n">vertex_set_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,:]</span> <span class="c1"># set all the boundaries to black</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">finally export the mesh with color</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">protrusion_labels_final_mesh</span> <span class="o">=</span> <span class="n">protrusion_labels_mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span> <span class="o">=</span> <span class="n">protrusion_labels_color</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savefolder</span><span class="p">,</span>
                                         <span class="s1">&#39;instance_segmentation_final_Cartesian_3D_</span><span class="si">%s</span><span class="s1">.obj&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">basefname</span><span class="p">)))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visualize in matplotlib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">mesh_S</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">mesh_S</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> 
            <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">protrusion_labels_final_mesh</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">vertex_colors</span><span class="p">[::</span><span class="n">sampling</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/727128114d77cfcec4b84cb28378d34debe9dd94a9ac63caa8bdc014255384b4.png" src="../_images/727128114d77cfcec4b84cb28378d34debe9dd94a9ac63caa8bdc014255384b4.png" />
</div>
</div>
</section>
<section id="s-d-u-v">
<h3><span class="math notranslate nohighlight">\(S(d,u,v)\)</span><a class="headerlink" href="#s-d-u-v" title="Link to this heading">#</a></h3>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./13_segmenting_surface_protrusions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="binary_segment_protrusions.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Binary protrusion segmentation</p>
      </div>
    </a>
    <a class="right-next"
       href="../14_volumizing_reference_and_protrusions/readme.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Decomposing surface into reference and protrusion meshes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-the-surface-mesh">0. Read in the surface mesh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-mean-curvature-and-binary-segmentation">1. Measure mean curvature and binary segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s-x-y-z"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connected-component-analysis-to-label-unique-protrusion-tips">2. Connected component analysis to label unique protrusion tips</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#postprocessing-and-diffusion-of-protrusion-tips-segmentation">3. Postprocessing and diffusion of protrusion tips segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><span class="math notranslate nohighlight">\(S(x,y,z)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#s-d-u-v"><span class="math notranslate nohighlight">\(S(d,u,v)\)</span></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Felix Y. Zhou
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://github.com/fyz11/u-Unwrap3D_notebooks/blob/main/LICENSE" target="_blank">GPL3</a> unless mentioned otherwise. 
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>